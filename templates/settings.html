{% extends "base.html" %}

{% block title %}设置 - OpenManus{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-cog me-2"></i>设置</h2>

            <!-- 导航标签 -->
            <ul class="nav nav-tabs mt-4" id="settingsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile"
                        type="button" role="tab">
                        <i class="fas fa-user me-2"></i>个人信息
                    </button>
                </li>
                {% if session.role == 'super_admin' %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button"
                        role="tab">
                        <i class="fas fa-users me-2"></i>用户管理
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="roles-tab" data-bs-toggle="tab" data-bs-target="#roles" type="button"
                        role="tab">
                        <i class="fas fa-user-shield me-2"></i>角色管理
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button"
                        role="tab">
                        <i class="fas fa-cogs me-2"></i>系统配置
                    </button>
                </li>
                {% endif %}
            </ul>

            <!-- 标签内容 -->
            <div class="tab-content mt-4" id="settingsTabContent">
                <!-- 个人信息标签 -->
                <div class="tab-pane fade show active" id="profile" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-user me-2"></i>个人信息</h5>
                        </div>
                        <div class="card-body">
                            <form id="profileForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="username" class="form-label">用户名</label>
                                            <input type="text" class="form-control" id="username" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="email" class="form-label">邮箱</label>
                                            <input type="email" class="form-control" id="email">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="currentPassword" class="form-label">当前密码</label>
                                            <input type="password" class="form-control" id="currentPassword">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="newPassword" class="form-label">新密码（留空则不修改）</label>
                                            <input type="password" class="form-control" id="newPassword">
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>保存更改
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                {% if session.role == 'super_admin' %}
                <!-- 用户管理标签 -->
                <div class="tab-pane fade" id="users" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-users me-2"></i>用户管理</h5>
                            <button class="btn btn-primary btn-sm" onclick="showCreateUserModal()">
                                <i class="fas fa-plus me-2"></i>创建用户
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="usersTable">
                                    <thead>
                                        <tr>
                                            <th>用户名</th>
                                            <th>邮箱</th>
                                            <th>角色</th>
                                            <th>状态</th>
                                            <th>创建时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 用户数据将通过JavaScript加载 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 角色管理标签 -->
                <div class="tab-pane fade" id="roles" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-user-shield me-2"></i>角色管理</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card border-primary">
                                        <div class="card-body text-center">
                                            <i class="fas fa-user fa-3x text-primary mb-3"></i>
                                            <h5>普通用户</h5>
                                            <p class="text-muted">基本聊天功能</p>
                                            <ul class="list-unstyled text-start">
                                                <li><i class="fas fa-check text-success me-2"></i>使用聊天功能</li>
                                                <li><i class="fas fa-check text-success me-2"></i>查看对话历史</li>
                                                <li><i class="fas fa-check text-success me-2"></i>修改个人信息</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-warning">
                                        <div class="card-body text-center">
                                            <i class="fas fa-user-tie fa-3x text-warning mb-3"></i>
                                            <h5>管理员</h5>
                                            <p class="text-muted">用户管理权限</p>
                                            <ul class="list-unstyled text-start">
                                                <li><i class="fas fa-check text-success me-2"></i>所有普通用户权限</li>
                                                <li><i class="fas fa-check text-success me-2"></i>查看用户列表</li>
                                                <li><i class="fas fa-check text-success me-2"></i>管理用户状态</li>
                                                <li><i class="fas fa-check text-success me-2"></i>查看系统统计</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-danger">
                                        <div class="card-body text-center">
                                            <i class="fas fa-user-crown fa-3x text-danger mb-3"></i>
                                            <h5>超级管理员</h5>
                                            <p class="text-muted">完全管理权限</p>
                                            <ul class="list-unstyled text-start">
                                                <li><i class="fas fa-check text-success me-2"></i>所有管理员权限</li>
                                                <li><i class="fas fa-check text-success me-2"></i>创建/删除用户</li>
                                                <li><i class="fas fa-check text-success me-2"></i>修改用户角色</li>
                                                <li><i class="fas fa-check text-success me-2"></i>系统配置管理</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 系统配置标签 -->
                <div class="tab-pane fade" id="config" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>系统配置</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>注意：</strong>修改系统配置可能影响系统运行，请谨慎操作。修改后可能需要重启服务才能生效。
                            </div>
                            <div id="configContent">
                                <!-- 配置内容将通过JavaScript加载 -->
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 创建用户模态框 -->
{% if session.role == 'super_admin' %}
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">创建新用户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="mb-3">
                        <label for="newUsername" class="form-label">用户名</label>
                        <input type="text" class="form-control" id="newUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="newUserEmail" class="form-label">邮箱</label>
                        <input type="email" class="form-control" id="newUserEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="newUserPassword" class="form-label">密码</label>
                        <input type="password" class="form-control" id="newUserPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="newUserRole" class="form-label">角色</label>
                        <select class="form-select" id="newUserRole" required>
                            <option value="user">普通用户</option>
                            <option value="admin">管理员</option>
                            <option value="super_admin">超级管理员</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="createUser()">创建</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function () {
        loadUserProfile();
        {% if session.role == 'super_admin' %}
        loadUsers();
        {% endif %}
    });

    // 加载用户个人信息
    function loadUserProfile() {
        fetch('/api/profile')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('username').value = data.user.username;
                    document.getElementById('email').value = data.user.email;
                }
            })
            .catch(error => {
                console.error('加载用户信息失败:', error);
            });
    }

    // 保存个人信息
    document.getElementById('profileForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = {
            email: document.getElementById('email').value,
            currentPassword: document.getElementById('currentPassword').value,
            newPassword: document.getElementById('newPassword').value
        };

        fetch('/api/profile', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('个人信息更新成功！');
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                } else {
                    alert('更新失败: ' + data.error);
                }
            })
            .catch(error => {
                console.error('更新失败:', error);
                alert('更新失败，请稍后重试');
            });
    });

    {% if session.role == 'super_admin' %}
    // 加载用户列表
    function loadUsers() {
        fetch('/admin/users')
            .then(response => response.json())
            .then(users => {
                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = '';

                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>
                        <select class="form-select form-select-sm" onchange="updateUserRole(${user.id}, this.value)">
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>普通用户</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>管理员</option>
                            <option value="super_admin" ${user.role === 'super_admin' ? 'selected' : ''}>超级管理员</option>
                        </select>
                    </td>
                    <td>
                        <span class="badge ${user.is_active ? 'bg-success' : 'bg-secondary'}">
                            ${user.is_active ? '活跃' : '禁用'}
                        </span>
                    </td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm ${user.is_active ? 'btn-warning' : 'btn-success'}"
                                onclick="toggleUserStatus(${user.id}, ${!user.is_active})">
                            ${user.is_active ? '禁用' : '启用'}
                        </button>
                        <button class="btn btn-sm btn-danger ms-1" onclick="deleteUser(${user.id})">
                            删除
                        </button>
                    </td>
                `;
                    tbody.appendChild(row);
                });
            })
            .catch(error => {
                console.error('加载用户列表失败:', error);
            });
    }

    // 显示创建用户模态框
    function showCreateUserModal() {
        const modal = new bootstrap.Modal(document.getElementById('createUserModal'));
        modal.show();
    }

    // 创建用户
    function createUser() {
        const formData = {
            username: document.getElementById('newUsername').value,
            email: document.getElementById('newUserEmail').value,
            password: document.getElementById('newUserPassword').value,
            role: document.getElementById('newUserRole').value
        };

        fetch('/admin/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('用户创建成功！');
                    bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                    document.getElementById('createUserForm').reset();
                    loadUsers();
                } else {
                    alert('创建失败: ' + data.error);
                }
            })
            .catch(error => {
                console.error('创建用户失败:', error);
                alert('创建失败，请稍后重试');
            });
    }

    // 更新用户角色
    function updateUserRole(userId, newRole) {
        fetch(`/admin/users/${userId}/role`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ role: newRole })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('角色更新成功！');
                } else {
                    alert('更新失败: ' + data.error);
                    loadUsers(); // 重新加载以恢复原状态
                }
            })
            .catch(error => {
                console.error('更新角色失败:', error);
                alert('更新失败，请稍后重试');
                loadUsers();
            });
    }

    // 切换用户状态
    function toggleUserStatus(userId, newStatus) {
        fetch(`/admin/users/${userId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_active: newStatus })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('状态更新成功！');
                    loadUsers();
                } else {
                    alert('更新失败: ' + data.error);
                }
            })
            .catch(error => {
                console.error('更新状态失败:', error);
                alert('更新失败，请稍后重试');
            });
    }

    // 删除用户
    function deleteUser(userId) {
        if (confirm('确定要删除这个用户吗？此操作不可恢复。')) {
            fetch(`/admin/users/${userId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('用户删除成功！');
                        loadUsers();
                    } else {
                        alert('删除失败: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('删除用户失败:', error);
                    alert('删除失败，请稍后重试');
                });
        }
    }

    // 加载配置文件
    function loadConfigs() {
        fetch('/admin/config')
            .then(response => response.json())
            .then(configs => {
                const configContent = document.getElementById('configContent');
                configContent.innerHTML = '';

                // 优先显示 config.toml
                const configToml = configs.find(config => config.filename === 'config.toml');
                if (configToml) {
                    const configDiv = createConfigDiv(configToml, true);
                    configContent.appendChild(configDiv);
                }

                // 显示其他配置文件
                configs.filter(config => config.filename !== 'config.toml').forEach(config => {
                    const configDiv = createConfigDiv(config, false);
                    configContent.appendChild(configDiv);
                });
            })
            .catch(error => {
                console.error('加载配置失败:', error);
                document.getElementById('configContent').innerHTML =
                    '<div class="alert alert-danger">加载配置文件失败</div>';
            });
    }

    // 创建配置文件显示区域
    function createConfigDiv(config, isMainConfig) {
        const div = document.createElement('div');
        div.className = 'mb-4';

        const title = isMainConfig ? `${config.filename} (主配置文件)` : config.filename;
        const cardClass = isMainConfig ? 'border-warning' : '';
        const textareaClass = isMainConfig ? 'config-toml-textarea' : '';

        div.innerHTML = `
        <div class="card ${cardClass}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">${title}</h6>
                <button class="btn btn-primary btn-sm" onclick="saveConfig('${config.filename}')">
                    <i class="fas fa-save me-1"></i>保存
                </button>
            </div>
            <div class="card-body">
                ${isMainConfig ? '<div class="alert alert-warning mb-3"><i class="fas fa-exclamation-triangle me-2"></i>这是系统主配置文件，修改后需要重启服务才能生效。</div>' : ''}
                <textarea class="form-control ${textareaClass}" id="config-${config.filename}" rows="20" style="font-family: monospace; line-height: 1.4;">${config.content}</textarea>
            </div>
        </div>
    `;

        return div;
    }

    // 保存配置文件
    function saveConfig(filename) {
        const content = document.getElementById(`config-${filename}`).value;

        // 对于 config.toml 文件，显示确认提示
        if (filename === 'config.toml') {
            if (!confirm('您正在修改主配置文件，这可能影响系统运行。确定要保存吗？')) {
                return;
            }
        }

        fetch(`/admin/config/${filename}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content: content })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (filename === 'config.toml') {
                        alert('主配置文件保存成功！\n\n注意：配置更改可能需要重启服务才能生效。');
                    } else {
                        alert('配置保存成功！');
                    }
                } else {
                    alert('保存失败: ' + data.error);
                }
            })
            .catch(error => {
                console.error('保存配置失败:', error);
                alert('保存失败，请稍后重试');
            });
    }

    // 当切换到配置标签时加载配置
    document.getElementById('config-tab').addEventListener('click', function () {
        loadConfigs();
    });
    {% endif %}
</script>

<style>
    .config-toml-textarea {
        border: 2px solid #ffc107 !important;
        background-color: #fff9e6 !important;
    }

    .card.border-warning .card-header {
        background-color: #fff3cd;
        border-bottom: 1px solid #ffc107;
    }

    .card.border-warning .card-header h6 {
        color: #856404;
        font-weight: bold;
    }
</style>
{% endblock %}
