{% extends "base.html" %}

{% block title %}OpenManus - AI 助手{% endblock %}

{% block content %}
<div class="row g-0">
    <!-- Sidebar -->
    <div class="col-md-3 sidebar" id="sidebar">
        <div class="p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="fas fa-comments me-2"></i>对话列表
                </h5>
                <button class="btn btn-outline-secondary btn-sm" id="newChatBtn">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            
            <div id="conversationsList">
                <!-- Conversations will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="col-md-9">
        <div class="chat-container">
            <!-- Chat Header -->
            <div class="bg-white border-bottom p-3 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <h5 class="mb-0" id="chatTitle">
                        <i class="fas fa-robot me-2 text-primary"></i>
                        <span id="conversationTitle">选择一个对话或开始新对话</span>
                    </h5>
                    <small class="text-muted" id="chatSubtitle">OpenManus AI 助手</small>
                </div>
            </div>
            
            <!-- Chat Messages -->
            <div class="chat-messages" id="chatMessages">
                <div class="text-center text-muted" id="welcomeMessage">
                    <div class="mb-4">
                        <i class="fas fa-robot fa-4x text-primary mb-3"></i>
                        <h3>欢迎使用 OpenManus</h3>
                        <p class="lead">您的智能 AI 助手已准备就绪！</p>
                        <div class="row mt-4">
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 border-0 bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-code fa-2x text-primary mb-2"></i>
                                        <h6>代码开发</h6>
                                        <small>编写、调试和解释代码</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 border-0 bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-search fa-2x text-primary mb-2"></i>
                                        <h6>研究分析</h6>
                                        <small>查找信息和分析数据</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 border-0 bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-tasks fa-2x text-primary mb-2"></i>
                                        <h6>任务自动化</h6>
                                        <small>自动化工作流程和流程</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Loading Indicator -->
            <div class="loading" id="loadingIndicator">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2 text-muted">OpenManus 正在思考...</p>
            </div>
            
            <!-- Chat Input -->
            <div class="chat-input">
                <form id="chatForm">
                    <div class="position-relative">
                        <textarea class="form-control" id="messageInput" 
                                  placeholder="在此输入您的消息..." 
                                  rows="4" 
                                  style="resize: none; padding-right: 60px; min-height: 100px; border: 2px solid #007bff; border-radius: 8px; background-color: #f8f9fa; box-shadow: 0 2px 4px rgba(0,123,255,0.1);"></textarea>
                        <button class="btn btn-primary btn-sm position-absolute" type="submit" id="sendBtn" 
                                style="bottom: 8px; right: 8px; z-index: 10; border-radius: 8px; width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-paper-plane" style="font-size: 14px;"></i>
                        </button>
                    </div>
                </form>
                <div class="text-center mt-2">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        OpenManus 可能会出错。请验证重要信息。按 Shift+Enter 换行，Enter 发送。
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div class="modal fade" id="newChatModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>新建对话
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newChatForm">
                    <div class="mb-3">
                        <label for="chatTitleInput" class="form-label">对话标题</label>
                        <input type="text" class="form-control" id="chatTitleInput" 
                               placeholder="为此对话输入标题" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="createChatBtn">
                    <i class="fas fa-plus me-2"></i>创建
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sign-in-alt me-2"></i>登录
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>默认账户：</strong> admin / admin123
                </div>
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">用户名</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">密码</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="remember" name="remember">
                        <label class="form-check-label" for="remember">记住我</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-outline-primary" id="guestBtn">
                    <i class="fas fa-user me-2"></i>游客访问
                </button>
                <button type="button" class="btn btn-primary" id="loginBtn">
                    <i class="fas fa-sign-in-alt me-2"></i>登录
                </button>
                <button type="button" class="btn btn-success" id="registerBtn">
                    <i class="fas fa-user-plus me-2"></i>注册
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Register Modal -->
<div class="modal fade" id="registerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>注册
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="mb-3">
                        <label for="regUsername" class="form-label">用户名</label>
                        <input type="text" class="form-control" id="regUsername" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="regPassword" class="form-label">密码</label>
                        <input type="password" class="form-control" id="regPassword" name="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">确认密码</label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" id="submitRegisterBtn">
                    <i class="fas fa-user-plus me-2"></i>注册
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
#messageInput:focus {
    border-color: #0056b3 !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25), 0 4px 8px rgba(0,123,255,0.2) !important;
    background-color: #ffffff !important;
}

#messageInput:hover {
    border-color: #0056b3 !important;
    box-shadow: 0 2px 6px rgba(0,123,255,0.15) !important;
}

.cursor {
    animation: blink 1s infinite;
    color: #007bff;
    font-weight: bold;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}

.streaming-content {
    white-space: pre-wrap;
}
</style>

<script>
let currentConversationId = null;
let conversations = [];
let isGuest = false;

$(document).ready(function() {
    // 检查是否为游客模式
    const urlParams = new URLSearchParams(window.location.search);
    isGuest = urlParams.get('guest') === 'true';
    
    if (isGuest) {
        // 游客模式，创建临时会话
        $('#conversationTitle').text('游客模式');
        $('#chatSubtitle').text('游客访问 - 数据不会保存');
        enableChat();
    } else {
        loadConversations();
        checkUserAuth();
    }
    
    // 聊天表单提交
    $('#chatForm').submit(function(e) {
        e.preventDefault();
        
        // 检查登录状态
        if (!isGuest && !currentConversationId) {
            // 已登录但没有选择对话，自动创建新对话
            const message = $('#messageInput').val().trim();
            if (message) {
                createNewConversationAndSend(message);
            }
            return;
        }
        
        sendMessage();
    });
    
    // 消息输入框键盘事件处理
    $('#messageInput').on('keydown', function(e) {
        // Enter键发送消息（不按Shift）
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            $('#chatForm').submit();
        }
    });
    
    // 自动调整textarea高度
    $('#messageInput').on('input', function() {
        const minHeight = 100; // 4行的高度
        const maxHeight = 200; // 8行的高度
        
        this.style.height = 'auto';
        const newHeight = Math.max(minHeight, Math.min(this.scrollHeight, maxHeight));
        this.style.height = newHeight + 'px';
        
        // 如果内容超过最大高度，显示滚动条
        if (this.scrollHeight > maxHeight) {
            this.style.overflowY = 'auto';
        } else {
            this.style.overflowY = 'hidden';
        }
    });
    
    // 新建对话
    $('#newChatBtn').click(function() {
        if (isGuest) {
            alert('游客模式下无法创建新对话');
            return;
        }
        $('#newChatModal').modal('show');
    });
    
    // 创建新对话
    $('#createChatBtn').click(function() {
        const title = $('#chatTitleInput').val().trim();
        if (!title) {
            alert('请输入对话标题');
            return;
        }
        
        createNewConversation(title);
    });
    
    // 侧边栏切换
    $('#toggleSidebar').click(function() {
        $('#sidebar').toggleClass('show');
    });
    
    // 登录相关事件
    setupLoginEvents();
});

function checkLoginAndSend() {
    // 检查用户是否已登录
    $.ajax({
        url: '/api/check-auth',
        method: 'GET',
        success: function(response) {
            if (response.authenticated) {
                // 已登录，直接发送消息
                sendMessage();
            } else {
                // 未登录，显示登录框
                $('#loginModal').modal('show');
            }
        },
        error: function() {
            // 检查失败，显示登录框
            $('#loginModal').modal('show');
        }
    });
}

function sendMessage() {
    const message = $('#messageInput').val().trim();
    if (!message) return;
    
    // 添加用户消息到界面
    addMessage('user', message);
    $('#messageInput').val('');
    
    // 显示加载指示器
    $('#loadingIndicator').show();
    
    // 创建助手消息容器，准备接收流式输出
    const assistantMessageId = 'msg-' + Date.now();
    addStreamingMessage('assistant', '', assistantMessageId);
    
    // 发送消息到后端并接收流式响应
    const endpoint = isGuest ? '/api/chat-guest-stream' : '/api/chat-stream';
    const data = isGuest ? { message: message } : { 
        message: message, 
        conversation_id: currentConversationId 
    };
    
    // 使用fetch API支持流式响应
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        function readStream() {
            return reader.read().then(({ done, value }) => {
                if (done) {
                    $('#loadingIndicator').hide();
                    return;
                }
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // 保留不完整的行
                
                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6);
                        if (data === '[DONE]') {
                            $('#loadingIndicator').hide();
                            return;
                        }
                        
                        try {
                            const parsed = JSON.parse(data);
                            if (parsed.type === 'content') {
                                appendToStreamingMessage(assistantMessageId, parsed.content);
                            } else if (parsed.type === 'error') {
                                $('#loadingIndicator').hide();
                                addMessage('system', '抱歉，发生了错误：' + parsed.message);
                                return;
                            } else if (parsed.type === 'done') {
                                 $('#loadingIndicator').hide();
                                 finalizeStreamingMessage(assistantMessageId);
                                 if (!isGuest && parsed.conversation_id) {
                                     currentConversationId = parsed.conversation_id;
                                     loadConversations();
                                 }
                                 return;
                             }
                        } catch (e) {
                            console.error('Error parsing SSE data:', e);
                        }
                    }
                });
                
                return readStream();
            });
        }
        
        return readStream();
    })
    .catch(error => {
        $('#loadingIndicator').hide();
        console.error('Fetch error:', error);
        addMessage('system', '网络错误，请重试');
    });
}

function addMessage(type, content) {
    const messagesContainer = $('#chatMessages');
    $('#welcomeMessage').hide();
    
    const messageHtml = `
        <div class="message ${type}-message">
            <div class="message-content">
                <div class="message-header">
                    <i class="fas ${type === 'user' ? 'fa-user' : type === 'assistant' ? 'fa-robot' : 'fa-info-circle'}"></i>
                    <span class="message-sender">${type === 'user' ? '您' : type === 'assistant' ? 'OpenManus' : '系统'}</span>
                    <span class="message-time">${new Date().toLocaleTimeString()}</span>
                </div>
                <div class="message-text">${content}</div>
            </div>
        </div>
    `;
    
    messagesContainer.append(messageHtml);
    messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
}

function addStreamingMessage(type, content, messageId) {
    const messagesContainer = $('#chatMessages');
    $('#welcomeMessage').hide();
    
    const messageHtml = `
        <div class="message ${type}-message" id="${messageId}">
            <div class="message-content">
                <div class="message-header">
                    <i class="fas ${type === 'user' ? 'fa-user' : type === 'assistant' ? 'fa-robot' : 'fa-info-circle'}"></i>
                    <span class="message-sender">${type === 'user' ? '您' : type === 'assistant' ? 'OpenManus' : '系统'}</span>
                    <span class="message-time">${new Date().toLocaleTimeString()}</span>
                </div>
                <div class="message-text"><span class="streaming-content">${content}</span><span class="cursor">▋</span></div>
            </div>
        </div>
    `;
    
    messagesContainer.append(messageHtml);
    messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
}

function appendToStreamingMessage(messageId, content) {
    const messageElement = $(`#${messageId} .streaming-content`);
    if (messageElement.length) {
        const currentContent = messageElement.text();
        messageElement.text(currentContent + content);
        $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
    }
}

function finalizeStreamingMessage(messageId) {
    const messageElement = $(`#${messageId}`);
    if (messageElement.length) {
        messageElement.find('.cursor').remove();
        const content = messageElement.find('.streaming-content').text();
        messageElement.find('.message-text').html(content.replace(/\n/g, '<br>'));
    }
}

function loadConversations() {
    if (isGuest) return;
    
    $.ajax({
        url: '/api/conversations',
        method: 'GET',
        success: function(response) {
            if (response.code === 200) {
                conversations = response.data.conversations;
                renderConversations();
                enableChat();
            }
        },
        error: function() {
            console.error('Failed to load conversations');
        }
    });
}

function renderConversations() {
    const container = $('#conversationsList');
    container.empty();
    
    if (conversations.length === 0) {
        container.append('<p class="text-muted small">暂无对话</p>');
        return;
    }
    
    conversations.forEach(conv => {
        const isActive = conv.id === currentConversationId;
        const convHtml = `
            <div class="conversation-item ${isActive ? 'active' : ''}" data-id="${conv.id}">
                <div class="conversation-title">${conv.title}</div>
                <div class="conversation-time">${conv.created_at || 'N/A'}</div>
            </div>
        `;
        container.append(convHtml);
    });
    
    // 绑定点击事件
    $('.conversation-item').click(function() {
        const convId = $(this).data('id');
        selectConversation(convId);
    });
}

function selectConversation(convId) {
    currentConversationId = convId;
    const conv = conversations.find(c => c.id === convId);
    if (conv) {
        $('#conversationTitle').text(conv.title);
        loadMessages(convId);
    }
    renderConversations();
}

function loadMessages(convId) {
    $.ajax({
        url: `/api/conversations/${convId}/messages`,
        method: 'GET',
        success: function(response) {
            if (response.code === 200) {
                const messagesContainer = $('#chatMessages');
                messagesContainer.empty();
                $('#welcomeMessage').hide();
                
                response.data.messages.forEach(msg => {
                    addMessage(msg.role, msg.content);
                });
            }
        },
        error: function() {
            console.error('Failed to load messages');
        }
    });
}

function createNewConversation(title) {
    $.ajax({
        url: '/api/conversations',
        method: 'POST',
        data: { title: title },
        success: function(response) {
            if (response.code === 200) {
                $('#newChatModal').modal('hide');
                $('#chatTitleInput').val('');
                currentConversationId = response.data.conversation_id;
                $('#conversationTitle').text(title);
                loadConversations();
                
                // 清空消息区域
                $('#chatMessages').empty();
                $('#welcomeMessage').show();
            } else {
                alert('创建对话失败：' + (response.message || '未知错误'));
            }
        },
        error: function() {
            alert('创建对话失败，请重试');
        }
    });
}

function createNewConversationAndSend(message) {
    // 使用消息的前20个字符作为对话标题
    const title = message.length > 20 ? message.substring(0, 20) + '...' : message;
    
    $.ajax({
        url: '/api/conversations',
        method: 'POST',
        data: { title: title },
        success: function(response) {
            if (response.code === 200) {
                currentConversationId = response.data.conversation_id;
                $('#conversationTitle').text(title);
                loadConversations();
                
                // 清空消息区域
                $('#chatMessages').empty();
                $('#welcomeMessage').hide();
                
                // 立即发送消息
                sendMessage();
            } else {
                alert('创建对话失败：' + (response.message || '未知错误'));
            }
        },
        error: function() {
            alert('创建对话失败，请重试');
        }
    });
}

function enableChat() {
    $('#messageInput').prop('disabled', false);
    $('#sendBtn').prop('disabled', false);
}

function checkUserAuth() {
    $.ajax({
        url: '/api/check-auth',
        method: 'GET',
        success: function(response) {
            if (response.code === 200 && response.data.authenticated) {
                $('#user-info').show();
                // 优先显示昵称，如果没有昵称则显示用户名
                const displayName = response.data.display_name || response.data.username;
                $('#username-display').text(displayName);
                
                // 如果是管理员或超级管理员，显示管理面板链接
                if (response.data.role === 'admin' || response.data.role === 'super_admin') {
                    if ($('#admin-link').length === 0) {
                        $('#user-info').append('<a href="/admin" id="admin-link" class="btn btn-sm btn-outline-primary ms-2"><i class="fas fa-cog me-1"></i>管理面板</a>');
                    }
                }
            }
        },
        error: function() {
            console.log('用户未登录');
        }
    });
}

function setupLoginEvents() {
    // 登录按钮
    $('#loginBtn').click(function() {
        const username = $('#username').val();
        const password = $('#password').val();
        const remember = $('#remember').is(':checked');

        if (!username || !password) {
            alert('请输入用户名和密码');
            return;
        }

        $.ajax({
            url: '/login',
            method: 'POST',
            data: {
                username: username,
                password: password,
                remember: remember
            },
            success: function(response) {
                if (response.code === 200) {
                    $('#loginModal').modal('hide');
                    isGuest = false;
                    loadConversations();
                    checkUserAuth();
                    // 发送之前输入的消息
                    sendMessage();
                } else {
                    alert(response.message || '登录失败');
                }
            },
            error: function() {
                alert('登录请求失败，请重试');
            }
        });
    });

    // 注册按钮
    $('#registerBtn').click(function() {
        $('#loginModal').modal('hide');
        $('#registerModal').modal('show');
    });

    // 注册提交
    $('#submitRegisterBtn').click(function() {
        const username = $('#regUsername').val();
        const password = $('#regPassword').val();
        const confirmPassword = $('#confirmPassword').val();

        if (!username || !password || !confirmPassword) {
            alert('请填写所有字段');
            return;
        }

        if (password !== confirmPassword) {
            alert('密码不匹配');
            return;
        }

        $.ajax({
            url: '/register',
            method: 'POST',
            data: {
                username: username,
                password: password
            },
            success: function(response) {
                if (response.code === 200) {
                    $('#registerModal').modal('hide');
                    alert('注册成功！请登录');
                    $('#loginModal').modal('show');
                } else {
                    alert(response.message || '注册失败');
                }
            },
            error: function() {
                alert('注册请求失败，请重试');
            }
        });
    });

    // 游客访问
    $('#guestBtn').click(function() {
        $('#loginModal').modal('hide');
        isGuest = true;
        $('#conversationTitle').text('游客模式');
        $('#chatSubtitle').text('游客访问 - 数据不会保存');
        // 发送之前输入的消息
        sendMessage();
    });
}
</script>
{% endblock %}