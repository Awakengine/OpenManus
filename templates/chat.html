{% extends "base.html" %}

{% block title %}OpenManus - AI åŠ©æ‰‹{% endblock %}

{% block extra_css %}
<style>
    /* é¡¶éƒ¨æç¤ºæ¡†æ ·å¼ */
    .tips-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1050;
        width: auto;
        max-width: 500px;
        min-width: 300px;
    }

    .tips-alert {
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 500;
        animation: slideDown 0.3s ease-out;
        border: none;
        position: relative;
        overflow: hidden;
    }

    .tips-alert::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: currentColor;
    }

    .tips-alert-success {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
        border-left: 4px solid #28a745;
    }

    .tips-alert-error {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        color: #721c24;
        border-left: 4px solid #dc3545;
    }

    .tips-alert-warning {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        color: #856404;
        border-left: 4px solid #ffc107;
    }

    .tips-alert-info {
        background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        color: #0c5460;
        border-left: 4px solid #17a2b8;
    }

    .tips-content {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
    }

    .tips-icon {
        font-size: 16px;
        margin-right: 4px;
    }

    .tips-close {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: inherit;
        opacity: 0.7;
        padding: 0;
        margin-left: 10px;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
    }

    .tips-close:hover {
        opacity: 1;
        background: rgba(0, 0, 0, 0.1);
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideUp {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(-20px);
        }
    }

    .tips-alert.removing {
        animation: slideUp 0.3s ease-out forwards;
    }

    /* ç¡®è®¤å¯¹è¯æ¡†æ ·å¼ */
    .confirm-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-out;
    }

    .confirm-dialog {
        background: white;
        border-radius: 12px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        animation: scaleIn 0.3s ease-out;
    }

    .confirm-header {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
    }

    .confirm-icon {
        font-size: 24px;
        margin-right: 12px;
        color: #ffc107;
    }

    .confirm-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin: 0;
    }

    .confirm-message {
        color: #666;
        margin-bottom: 24px;
        line-height: 1.5;
    }

    .confirm-buttons {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .confirm-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .confirm-btn-cancel {
        background: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
    }

    .confirm-btn-cancel:hover {
        background: #e9ecef;
    }

    .confirm-btn-confirm {
        background: #dc3545;
        color: white;
    }

    .confirm-btn-confirm:hover {
        background: #c82333;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }

    @keyframes scaleIn {
        from {
            opacity: 0;
            transform: scale(0.9);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- é¡¶éƒ¨æç¤ºæ¡†å®¹å™¨ -->
<div id="tipsContainer" class="tips-container"></div>
<div class="row g-0">
    <!-- Sidebar -->
    <div class="col-md-3 sidebar" id="sidebar">
        <div class="p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="fas fa-comments me-2"></i>å¯¹è¯åˆ—è¡¨
                </h5>
                <button class="btn btn-outline-secondary btn-sm" id="newChatBtn">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            
            <div id="conversationsList">
                <!-- Conversations will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="col-md-9">
        <div class="chat-container">
            <!-- Chat Header -->
            <div class="bg-white border-bottom p-3 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <h5 class="mb-0" id="chatTitle">
                        <i class="fas fa-robot me-2 text-primary"></i>
                        <span id="conversationTitle">é€‰æ‹©ä¸€ä¸ªå¯¹è¯æˆ–å¼€å§‹æ–°å¯¹è¯</span>
                    </h5>
                    <small class="text-muted" id="chatSubtitle">OpenManus AI åŠ©æ‰‹</small>
                </div>
            </div>
            
            <!-- Chat Messages -->
            <div class="chat-messages" id="chatMessages">
                <div class="text-center text-muted" id="welcomeMessage">
                    <div class="mb-4">
                        <i class="fas fa-robot fa-4x text-primary mb-3"></i>
                        <h3>æ¬¢è¿ä½¿ç”¨ OpenManus</h3>
                        <p class="lead">æ‚¨çš„æ™ºèƒ½ AI åŠ©æ‰‹å·²å‡†å¤‡å°±ç»ªï¼</p>
                        <div class="row mt-4">
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 border-0 bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-code fa-2x text-primary mb-2"></i>
                                        <h6>ä»£ç å¼€å‘</h6>
                                        <small>ç¼–å†™ã€è°ƒè¯•å’Œè§£é‡Šä»£ç </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 border-0 bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-search fa-2x text-primary mb-2"></i>
                                        <h6>ç ”ç©¶åˆ†æ</h6>
                                        <small>æŸ¥æ‰¾ä¿¡æ¯å’Œåˆ†ææ•°æ®</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 border-0 bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-tasks fa-2x text-primary mb-2"></i>
                                        <h6>ä»»åŠ¡è‡ªåŠ¨åŒ–</h6>
                                        <small>è‡ªåŠ¨åŒ–å·¥ä½œæµç¨‹å’Œæµç¨‹</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Loading Indicator -->
            <div class="loading" id="loadingIndicator">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                </div>
                <p class="mt-2 text-muted">OpenManus æ­£åœ¨æ€è€ƒ...</p>
            </div>
            
            <!-- Chat Input -->
            <div class="chat-input">
                <form id="chatForm">
                    <div class="position-relative">
                        <textarea class="form-control" id="messageInput" 
                                  placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„æ¶ˆæ¯..." 
                                  rows="4" 
                                  style="resize: none; padding-right: 60px; min-height: 100px; border: 2px solid #007bff; border-radius: 8px; background-color: #f8f9fa; box-shadow: 0 2px 4px rgba(0,123,255,0.1);"></textarea>
                        <button class="btn btn-primary btn-sm position-absolute" type="submit" id="sendBtn" 
                                style="bottom: 8px; right: 8px; z-index: 10; border-radius: 8px; width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-paper-plane" style="font-size: 14px;"></i>
                        </button>
                    </div>
                </form>
                <div class="text-center mt-2">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        OpenManus å¯èƒ½ä¼šå‡ºé”™ã€‚è¯·éªŒè¯é‡è¦ä¿¡æ¯ã€‚æŒ‰ Shift+Enter æ¢è¡Œï¼ŒEnter å‘é€ã€‚
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div class="modal fade" id="newChatModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>æ–°å»ºå¯¹è¯
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newChatForm">
                    <div class="mb-3">
                        <label for="chatTitleInput" class="form-label">å¯¹è¯æ ‡é¢˜</label>
                        <input type="text" class="form-control" id="chatTitleInput" 
                               placeholder="ä¸ºæ­¤å¯¹è¯è¾“å…¥æ ‡é¢˜" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="createChatBtn">
                    <i class="fas fa-plus me-2"></i>åˆ›å»º
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sign-in-alt me-2"></i>ç™»å½•
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>é»˜è®¤è´¦æˆ·ï¼š</strong> admin / admin123
                </div>
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">ç”¨æˆ·å</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">å¯†ç </label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="remember" name="remember">
                        <label class="form-check-label" for="remember">è®°ä½æˆ‘</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-outline-primary" id="guestBtn">
                    <i class="fas fa-user me-2"></i>æ¸¸å®¢è®¿é—®
                </button>
                <button type="button" class="btn btn-primary" id="loginBtn">
                    <i class="fas fa-sign-in-alt me-2"></i>ç™»å½•
                </button>
                <button type="button" class="btn btn-success" id="registerBtn">
                    <i class="fas fa-user-plus me-2"></i>æ³¨å†Œ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Register Modal -->
<div class="modal fade" id="registerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>æ³¨å†Œ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="mb-3">
                        <label for="regUsername" class="form-label">ç”¨æˆ·å</label>
                        <input type="text" class="form-control" id="regUsername" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="regPassword" class="form-label">å¯†ç </label>
                        <input type="password" class="form-control" id="regPassword" name="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">ç¡®è®¤å¯†ç </label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" id="submitRegisterBtn">
                    <i class="fas fa-user-plus me-2"></i>æ³¨å†Œ
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
#messageInput:focus {
    border-color: #0056b3 !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25), 0 4px 8px rgba(0,123,255,0.2) !important;
    background-color: #ffffff !important;
}

#messageInput:hover {
    border-color: #0056b3 !important;
    box-shadow: 0 2px 6px rgba(0,123,255,0.15) !important;
}

.cursor {
    animation: blink 1s infinite;
    color: #007bff;
    font-weight: bold;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}

.streaming-content {
    white-space: pre-wrap;
}

.conversation-item {
    padding: 12px;
    border-bottom: 1px solid #e9ecef;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.conversation-item:hover {
    background-color: #f8f9fa;
    transform: none !important;
}
.conversation-item.active {
    background-color: #e3f2fd;
    border-left: 4px solid #2196f3;
    transform: none !important;
}
.conversation-content {
    flex: 1;
    min-width: 0;
}
.conversation-title {
    font-weight: 500;
    margin-bottom: 4px;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.conversation-time {
    font-size: 0.85em;
    color: #666;
}
.conversation-actions {
    opacity: 0;
    transition: opacity 0.2s;
    margin-left: 8px;
}
.conversation-item:hover .conversation-actions {
    opacity: 1;
}
.delete-conversation {
    border: none;
    background: none;
    color: #dc3545;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background-color 0.2s;
}
.delete-conversation:hover {
    background-color: #dc3545;
    color: white;
}

/* æ¶ˆæ¯å¸ƒå±€æ ·å¼ */
.message {
    display: flex;
    margin-bottom: 16px;
    max-width: 100%;
}

/* ç”¨æˆ·æ¶ˆæ¯é å³ */
.message.user-message {
    justify-content: flex-end;
}

/* åŠ©æ‰‹å’Œç³»ç»Ÿæ¶ˆæ¯é å·¦ */
.message.assistant-message,
.message.system-message {
    justify-content: flex-start;
}

.message-content {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    position: relative;
}

/* ç”¨æˆ·æ¶ˆæ¯æ ·å¼ */
.message.user-message .message-content {
    background: linear-gradient(135deg, #007bff, #5dade2);
    color: white;
    border-bottom-right-radius: 6px;
}

/* åŠ©æ‰‹æ¶ˆæ¯æ ·å¼ */
.message.assistant-message .message-content {
    background: white;
    color: #333;
    border: 1px solid #e9ecef;
    border-bottom-left-radius: 6px;
}

/* ç³»ç»Ÿæ¶ˆæ¯æ ·å¼ */
.message.system-message .message-content {
    background: #f8f9fa;
    color: #6c757d;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    text-align: center;
    font-style: italic;
}

/* æ¶ˆæ¯ç¼–è¾‘ç›¸å…³æ ·å¼ */
.message-actions {
    opacity: 0;
    transition: opacity 0.2s;
    margin-left: auto;
    display: flex;
    gap: 4px;
}

.message:hover .message-actions {
    opacity: 1;
}

.edit-message-btn {
    padding: 2px 6px;
    font-size: 12px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    background: white;
    color: #6c757d;
}

.edit-message-btn:hover {
    background: #f8f9fa;
    color: #495057;
}

.message-edit-form {
    margin-top: 8px;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #dee2e6;
}

.message-edit-textarea {
    width: 100%;
    min-height: 60px;
    padding: 8px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    resize: vertical;
    font-family: inherit;
    font-size: 14px;
}

.message-edit-actions {
    margin-top: 8px;
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

.message-edit-actions .btn {
    padding: 4px 12px;
    font-size: 12px;
}

.message-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

/* ç”¨æˆ·æ¶ˆæ¯å¤´éƒ¨å³å¯¹é½ */
.message.user-message .message-header {
    justify-content: flex-end;
    flex-direction: row-reverse;
}

/* åŠ©æ‰‹å’Œç³»ç»Ÿæ¶ˆæ¯å¤´éƒ¨å·¦å¯¹é½ */
.message.assistant-message .message-header,
.message.system-message .message-header {
    justify-content: flex-start;
}

.message-sender {
    font-weight: 500;
}

.message-time {
    font-size: 12px;
    color: #6c757d;
}

/* ç”¨æˆ·æ¶ˆæ¯æ—¶é—´å’Œå‘é€è€…é¢œè‰²è°ƒæ•´ */
.message.user-message .message-time,
.message.user-message .message-sender {
    color: rgba(255, 255, 255, 0.8);
}

.message-text {
    line-height: 1.5;
}

/* Thinkingå®¹å™¨æ ·å¼ */
.thinking-container {
    margin: 10px 0;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background-color: #f8f9fa;
    overflow: hidden;
}

.thinking-header {
    padding: 12px 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: background-color 0.2s ease;
    user-select: none;
}

.thinking-header:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
}

.thinking-icon {
    margin-right: 8px;
    font-size: 16px;
}

.thinking-title {
    flex: 1;
    font-weight: 500;
    font-size: 14px;
}

.thinking-toggle {
    transition: transform 0.2s ease;
    font-size: 12px;
}

.thinking-content {
    padding: 16px;
    background-color: #ffffff;
    border-top: 1px solid #e9ecef;
    line-height: 1.6;
    color: #495057;
    font-size: 14px;
}

.thinking-content br {
    margin-bottom: 8px;
}
</style>

<script>
let currentConversationId = null;
let conversations = [];
let isGuest = false;
let pendingMessage = '';

// é¡¶éƒ¨æç¤ºæ¡†åŠŸèƒ½
function showTips(message, type = 'info', duration = 3000) {
    const container = document.getElementById('tipsContainer');
    if (!container) return;
    
    // åˆ›å»ºæç¤ºæ¡†å…ƒç´ 
    const alert = document.createElement('div');
    alert.className = `tips-alert tips-alert-${type}`;
    
    // æ ¹æ®ç±»å‹è®¾ç½®å›¾æ ‡
    let icon = '';
    switch(type) {
        case 'success':
            icon = 'âœ“';
            break;
        case 'error':
            icon = 'âœ—';
            break;
        case 'warning':
            icon = 'âš ';
            break;
        case 'info':
        default:
            icon = 'â„¹';
            break;
    }
    
    alert.innerHTML = `
        <div class="tips-content">
            <span class="tips-icon">${icon}</span>
            <span class="tips-message">${message}</span>
        </div>
        <button class="tips-close" onclick="closeTips(this)">&times;</button>
    `;
    
    // æ·»åŠ åˆ°å®¹å™¨
    container.appendChild(alert);
    
    // è‡ªåŠ¨å…³é—­
    if (duration > 0) {
        setTimeout(() => {
            closeTips(alert.querySelector('.tips-close'));
        }, duration);
    }
    
    return alert;
}

// å…³é—­æç¤ºæ¡†
function closeTips(closeBtn) {
    const alert = closeBtn.closest('.tips-alert');
    if (alert) {
        alert.classList.add('removing');
        setTimeout(() => {
            if (alert.parentNode) {
                alert.parentNode.removeChild(alert);
            }
        }, 300);
    }
}

// ç¡®è®¤å¯¹è¯æ¡†
function showConfirm(message, title = 'ç¡®è®¤æ“ä½œ', onConfirm = null, onCancel = null) {
    return new Promise((resolve) => {
        // åˆ›å»ºé®ç½©å±‚
        const overlay = document.createElement('div');
        overlay.className = 'confirm-overlay';
        
        overlay.innerHTML = `
            <div class="confirm-dialog">
                <div class="confirm-header">
                    <span class="confirm-icon">âš </span>
                    <h4 class="confirm-title">${title}</h4>
                </div>
                <div class="confirm-message">${message}</div>
                <div class="confirm-buttons">
                    <button class="confirm-btn confirm-btn-cancel">å–æ¶ˆ</button>
                    <button class="confirm-btn confirm-btn-confirm">ç¡®è®¤</button>
                </div>
            </div>
        `;
        
        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(overlay);
        
        // ç»‘å®šäº‹ä»¶
        const cancelBtn = overlay.querySelector('.confirm-btn-cancel');
        const confirmBtn = overlay.querySelector('.confirm-btn-confirm');
        
        const cleanup = () => {
            overlay.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => {
                if (overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
            }, 300);
        };
        
        cancelBtn.onclick = () => {
            cleanup();
            if (onCancel) onCancel();
            resolve(false);
        };
        
        confirmBtn.onclick = () => {
            cleanup();
            if (onConfirm) onConfirm();
            resolve(true);
        };
        
        // ç‚¹å‡»é®ç½©å±‚å…³é—­
        overlay.onclick = (e) => {
            if (e.target === overlay) {
                cleanup();
                if (onCancel) onCancel();
                resolve(false);
            }
        };
    });
}

$(document).ready(function() {
    // æ£€æŸ¥æ˜¯å¦ä¸ºæ¸¸å®¢æ¨¡å¼
    const urlParams = new URLSearchParams(window.location.search);
    isGuest = urlParams.get('guest') === 'true';
    
    if (isGuest) {
        // æ¸¸å®¢æ¨¡å¼ï¼Œåˆ›å»ºä¸´æ—¶ä¼šè¯
        $('#conversationTitle').text('æ¸¸å®¢æ¨¡å¼');
        $('#chatSubtitle').text('æ¸¸å®¢è®¿é—® - æ•°æ®ä¸ä¼šä¿å­˜');
        enableChat();
    } else {
        loadConversations();
        checkUserAuth();
    }
    
    // èŠå¤©è¡¨å•æäº¤
    $('#chatForm').submit(function(e) {
        e.preventDefault();
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!isGuest && !currentConversationId) {
            // å·²ç™»å½•ä½†æ²¡æœ‰é€‰æ‹©å¯¹è¯ï¼Œè‡ªåŠ¨åˆ›å»ºæ–°å¯¹è¯
            const message = $('#messageInput').val().trim();
            if (message) {
                createNewConversationAndSend(message);
            }
            return;
        }
        
        sendMessage();
    });
    
    // æ¶ˆæ¯è¾“å…¥æ¡†é”®ç›˜äº‹ä»¶å¤„ç†
    $('#messageInput').on('keydown', function(e) {
        // Enteré”®å‘é€æ¶ˆæ¯ï¼ˆä¸æŒ‰Shiftï¼‰
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            $('#chatForm').submit();
        }
    });
    
    // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
    $('#messageInput').on('input', function() {
        const minHeight = 100; // 4è¡Œçš„é«˜åº¦
        const maxHeight = 200; // 8è¡Œçš„é«˜åº¦
        
        this.style.height = 'auto';
        const newHeight = Math.max(minHeight, Math.min(this.scrollHeight, maxHeight));
        this.style.height = newHeight + 'px';
        
        // å¦‚æœå†…å®¹è¶…è¿‡æœ€å¤§é«˜åº¦ï¼Œæ˜¾ç¤ºæ»šåŠ¨æ¡
        if (this.scrollHeight > maxHeight) {
            this.style.overflowY = 'auto';
        } else {
            this.style.overflowY = 'hidden';
        }
    });
    
    // æ–°å»ºå¯¹è¯
    $('#newChatBtn').click(function() {
        if (isGuest) {
            alert('æ¸¸å®¢æ¨¡å¼ä¸‹æ— æ³•åˆ›å»ºæ–°å¯¹è¯');
            return;
        }
        $('#newChatModal').modal('show');
    });
    
    // åˆ›å»ºæ–°å¯¹è¯
    $('#createChatBtn').click(function() {
        const title = $('#chatTitleInput').val().trim();
        if (!title) {
            alert('è¯·è¾“å…¥å¯¹è¯æ ‡é¢˜');
            return;
        }
        
        createNewConversation(title);
    });
    
    // ä¾§è¾¹æ åˆ‡æ¢
    $('#toggleSidebar').click(function() {
        $('#sidebar').toggleClass('show');
    });
    
    // ç™»å½•ç›¸å…³äº‹ä»¶
    setupLoginEvents();
});

function checkLoginAndSend() {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
    $.ajax({
        url: '/api/check-auth',
        method: 'GET',
        success: function(response) {
            if (response.authenticated) {
                // å·²ç™»å½•ï¼Œç›´æ¥å‘é€æ¶ˆæ¯
                sendMessage();
            } else {
                // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æ¡†
                $('#loginModal').modal('show');
            }
        },
        error: function() {
            // æ£€æŸ¥å¤±è´¥ï¼Œæ˜¾ç¤ºç™»å½•æ¡†
            $('#loginModal').modal('show');
        }
    });
}

function sendMessage() {
    const message = $('#messageInput').val().trim();
    if (!message) return;
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
    addMessage('user', message);
    $('#messageInput').val('');
    
    // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
    $('#loadingIndicator').show();
    
    // åˆ›å»ºåŠ©æ‰‹æ¶ˆæ¯å®¹å™¨ï¼Œå‡†å¤‡æ¥æ”¶æµå¼è¾“å‡º
    const assistantMessageId = 'msg-' + Date.now();
    addStreamingMessage('assistant', '', assistantMessageId);
    
    // å‘é€æ¶ˆæ¯åˆ°åç«¯å¹¶æ¥æ”¶æµå¼å“åº”
    const endpoint = isGuest ? '/api/chat-guest-stream' : '/api/chat-stream';
    const data = isGuest ? { message: message } : { 
        message: message, 
        conversation_id: currentConversationId 
    };
    
    // ä½¿ç”¨fetch APIæ”¯æŒæµå¼å“åº”
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        function readStream() {
            return reader.read().then(({ done, value }) => {
                if (done) {
                    $('#loadingIndicator').hide();
                    return;
                }
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // ä¿ç•™ä¸å®Œæ•´çš„è¡Œ
                
                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6);
                        if (data === '[DONE]') {
                            $('#loadingIndicator').hide();
                            return;
                        }
                        
                        try {
                            const parsed = JSON.parse(data);
                            if (parsed.type === 'content') {
                                // æ£€æµ‹æ­¥éª¤ä¿¡æ¯å¹¶æ›´æ–°åŠ è½½æŒ‡ç¤ºå™¨
                                const stepMatch = parsed.content.match(/ğŸ“ \*\*æ­¥éª¤ (\d+):\*\*/);
                                if (stepMatch) {
                                    const stepNumber = stepMatch[1];
                                    $('#loadingIndicator p').text(`OpenManus æ­£åœ¨æ€è€ƒ... (æ­¥éª¤ ${stepNumber})`);
                                } else if (parsed.content.includes('ğŸ¤” å¼€å§‹æ€è€ƒ...')) {
                                    $('#loadingIndicator p').text('OpenManus æ­£åœ¨æ€è€ƒ... (åˆå§‹åŒ–)');
                                } else if (parsed.content.includes('âœ… **æœ€ç»ˆå›å¤:**')) {
                                    $('#loadingIndicator p').text('OpenManus æ­£åœ¨æ€è€ƒ... (ç”Ÿæˆå›å¤)');
                                }
                                
                                appendToStreamingMessage(assistantMessageId, parsed.content);
                            } else if (parsed.type === 'error') {
                                $('#loadingIndicator').hide();
                                addMessage('system', 'æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼š' + parsed.message);
                                return;
                            } else if (parsed.type === 'done') {
                                 $('#loadingIndicator').hide();
                                 finalizeStreamingMessage(assistantMessageId);
                                 if (!isGuest && parsed.conversation_id) {
                                     currentConversationId = parsed.conversation_id;
                                     loadConversations();
                                 }
                                 return;
                             }
                        } catch (e) {
                            console.error('Error parsing SSE data:', e);
                        }
                    }
                });
                
                return readStream();
            });
        }
        
        return readStream();
    })
    .catch(error => {
        $('#loadingIndicator').hide();
        console.error('Fetch error:', error);
        addMessage('system', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
    });
}

function addMessage(type, content) {
    const messagesContainer = $('#chatMessages');
    $('#welcomeMessage').hide();
    
    const messageDiv = $('<div>').addClass(`message ${type}-message`);
    const messageContent = $('<div>').addClass('message-content');
    const messageHeader = $('<div>').addClass('message-header');
    
    const icon = $('<i>').addClass(`fas ${type === 'user' ? 'fa-user' : type === 'assistant' ? 'fa-robot' : 'fa-info-circle'}`);
    const sender = $('<span>').addClass('message-sender').text(type === 'user' ? 'æ‚¨' : type === 'assistant' ? 'OpenManus' : 'ç³»ç»Ÿ');
    const time = $('<span>').addClass('message-time').text(new Date().toLocaleTimeString());
    const processedContent = processThinkingTags(content);
    const messageText = $('<div>').addClass('message-text').html(processedContent);
    
    // ä¸ºç”¨æˆ·æ¶ˆæ¯æ·»åŠ ç¼–è¾‘æŒ‰é’®
    if (type === 'user') {
        const messageActions = $('<div>').addClass('message-actions');
        const editBtn = $('<button>').addClass('btn btn-sm btn-outline-secondary edit-message-btn')
            .html('<i class="fas fa-edit"></i>')
            .attr('title', 'ç¼–è¾‘æ¶ˆæ¯')
            .data('original-content', content);
        messageActions.append(editBtn);
        messageHeader.append(messageActions);
    }
    
    messageHeader.append(icon, sender, time);
    messageContent.append(messageHeader, messageText);
    messageDiv.append(messageContent);
    
    messagesContainer.append(messageDiv);
    messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
}

function addStreamingMessage(type, content, messageId) {
    const messagesContainer = $('#chatMessages');
    $('#welcomeMessage').hide();
    
    const messageDiv = $('<div>').addClass(`message ${type}-message`).attr('id', messageId);
    const messageContent = $('<div>').addClass('message-content');
    const messageHeader = $('<div>').addClass('message-header');
    
    const icon = $('<i>').addClass(`fas ${type === 'user' ? 'fa-user' : type === 'assistant' ? 'fa-robot' : 'fa-info-circle'}`);
    const sender = $('<span>').addClass('message-sender').text(type === 'user' ? 'æ‚¨' : type === 'assistant' ? 'OpenManus' : 'ç³»ç»Ÿ');
    const time = $('<span>').addClass('message-time').text(new Date().toLocaleTimeString());
    
    const messageText = $('<div>').addClass('message-text');
    const streamingContent = $('<span>').addClass('streaming-content').text(content);
    const cursor = $('<span>').addClass('cursor').text('â–‹');
    messageText.append(streamingContent, cursor);
    
    messageHeader.append(icon, sender, time);
    messageContent.append(messageHeader, messageText);
    messageDiv.append(messageContent);
    
    messagesContainer.append(messageDiv);
    messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
}

function appendToStreamingMessage(messageId, content) {
    const messageElement = $(`#${messageId} .streaming-content`);
    if (messageElement.length) {
        const currentContent = messageElement.text();
        messageElement.text(currentContent + content);
        $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
    }
}

function finalizeStreamingMessage(messageId) {
    const messageElement = $(`#${messageId}`);
    if (messageElement.length) {
        messageElement.find('.cursor').remove();
        const content = messageElement.find('.streaming-content').text();
        const processedContent = processThinkingTags(content);
        messageElement.find('.message-text').html(processedContent);
    }
}

function processThinkingTags(content) {
    // å¤„ç†å¤šä¸ªç›¸è¿çš„Thinkingæ ‡ç­¾ï¼Œå°†å®ƒä»¬åˆå¹¶
    let processedContent = content;
    
    // åŒ¹é…æ‰€æœ‰Thinkingæ ‡ç­¾å¹¶å¤„ç†
    const thinkingRegex = /<Thinking>([\s\S]*?)<\/Thinking>/g;
    let thinkingBlocks = [];
    let match;
    
    while ((match = thinkingRegex.exec(content)) !== null) {
        thinkingBlocks.push(match[1].trim());
    }
    
    if (thinkingBlocks.length > 0) {
        // åˆå¹¶æ‰€æœ‰thinkingå†…å®¹
        const combinedThinking = thinkingBlocks.join('\n\n');
        
        // åˆ›å»ºå¯æŠ˜å çš„HTMLç»“æ„
        const thinkingHtml = `
            <div class="thinking-container">
                <div class="thinking-header" onclick="toggleThinking(this)">
                    <i class="fas fa-brain thinking-icon"></i>
                    <span class="thinking-title">æ€è€ƒè¿‡ç¨‹</span>
                    <i class="fas fa-chevron-down thinking-toggle"></i>
                </div>
                <div class="thinking-content" style="display: none;">
                    ${combinedThinking.replace(/\n/g, '<br>')}
                </div>
            </div>
        `;
        
        // ç§»é™¤åŸå§‹çš„Thinkingæ ‡ç­¾å¹¶æ›¿æ¢ä¸ºHTMLç»“æ„
        processedContent = content.replace(thinkingRegex, '').trim();
        
        // å¦‚æœè¿˜æœ‰å…¶ä»–å†…å®¹ï¼Œåœ¨thinkingåé¢æ·»åŠ 
        if (processedContent) {
            processedContent = thinkingHtml + '<br><br>' + processedContent.replace(/\n/g, '<br>');
        } else {
            processedContent = thinkingHtml;
        }
    } else {
        // æ²¡æœ‰thinkingæ ‡ç­¾ï¼Œæ­£å¸¸å¤„ç†æ¢è¡Œ
        processedContent = content.replace(/\n/g, '<br>');
    }
    
    return processedContent;
}

function toggleThinking(header) {
    const container = $(header).closest('.thinking-container');
    const content = container.find('.thinking-content');
    const toggle = container.find('.thinking-toggle');
    
    if (content.is(':visible')) {
        content.slideUp(200);
        toggle.removeClass('fa-chevron-up').addClass('fa-chevron-down');
    } else {
        content.slideDown(200);
        toggle.removeClass('fa-chevron-down').addClass('fa-chevron-up');
    }
}

function loadConversations() {
    if (isGuest) return;
    
    $.ajax({
        url: '/api/conversations',
        method: 'GET',
        success: function(response) {
            if (response.code === 200) {
                conversations = response.data.conversations;
                renderConversations();
                enableChat();
            }
        },
        error: function() {
            console.error('Failed to load conversations');
        }
    });
}

function renderConversations() {
    const container = $('#conversationsList');
    container.empty();
    
    if (conversations.length === 0) {
        container.append('<p class="text-muted small">æš‚æ— å¯¹è¯</p>');
        return;
    }
    
    conversations.forEach(conv => {
        const isActive = conv.id === currentConversationId;
        const convHtml = `
            <div class="conversation-item ${isActive ? 'active' : ''}" data-id="${conv.id}">
                <div class="conversation-content">
                    <div class="conversation-title">${conv.title}</div>
                    <div class="conversation-time">${conv.created_at || 'N/A'}</div>
                </div>
                <div class="conversation-actions">
                    <button class="btn btn-sm btn-outline-danger delete-conversation" data-id="${conv.id}" title="åˆ é™¤å¯¹è¯">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        container.append(convHtml);
    });
    
    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç»‘å®šç‚¹å‡»äº‹ä»¶
    $('#conversationsList').off('click', '.conversation-item .conversation-content').on('click', '.conversation-item .conversation-content', function() {
        const convId = $(this).parent().data('id');
        selectConversation(convId);
    });
    
    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
    $('#conversationsList').off('click', '.delete-conversation').on('click', '.delete-conversation', function(e) {
        e.stopPropagation();
        const convId = $(this).data('id');
        const conv = conversations.find(c => c.id === convId);
        showConfirm(
            `ç¡®å®šè¦åˆ é™¤å¯¹è¯ "${conv.title}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`,
            'åˆ é™¤å¯¹è¯',
            () => deleteConversation(convId)
        );
    });
}

function selectConversation(convId) {
    currentConversationId = convId;
    const conv = conversations.find(c => c.id === convId);
    if (conv) {
        $('#conversationTitle').text(conv.title);
        loadMessages(convId);
    }
    renderConversations();
}

function loadMessages(convId) {
    $.ajax({
        url: `/api/conversations/${convId}/messages`,
        method: 'GET',
        success: function(response) {
            if (response.code === 200) {
                const messagesContainer = $('#chatMessages');
                messagesContainer.empty();
                $('#welcomeMessage').hide();
                
                response.data.messages.forEach(msg => {
                    addMessage(msg.role, msg.content);
                });
            }
        },
        error: function() {
            console.error('Failed to load messages');
        }
    });
}

function deleteConversation(convId) {
    $.ajax({
        url: `/api/conversations/${convId}`,
        method: 'DELETE',
        success: function(response) {
            if (response.code === 200) {
                // ä»æœ¬åœ°æ•°ç»„ä¸­ç§»é™¤å¯¹è¯
                conversations = conversations.filter(c => c.id !== convId);
                
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯ï¼Œæ¸…ç©ºèŠå¤©åŒºåŸŸ
                if (currentConversationId === convId) {
                    currentConversationId = null;
                    $('#conversationTitle').text('é€‰æ‹©å¯¹è¯');
                    $('#chatMessages').empty();
                    $('#welcomeMessage').show();
                }
                
                // é‡æ–°æ¸²æŸ“å¯¹è¯åˆ—è¡¨
                renderConversations();
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showTips('å¯¹è¯åˆ é™¤æˆåŠŸ', 'success');
            } else {
                showTips(response.message || 'åˆ é™¤å¯¹è¯å¤±è´¥', 'error');
            }
        },
        error: function() {
            showTips('åˆ é™¤å¯¹è¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    });
}

function createNewConversation(title) {
    $.ajax({
        url: '/api/conversations',
        method: 'POST',
        data: { title: title },
        success: function(response) {
            if (response.code === 200) {
                $('#newChatModal').modal('hide');
                $('#chatTitleInput').val('');
                currentConversationId = response.data.conversation_id;
                $('#conversationTitle').text(title);
                loadConversations();
                
                // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
                $('#chatMessages').empty();
                $('#welcomeMessage').show();
            } else {
                showTips('åˆ›å»ºå¯¹è¯å¤±è´¥ï¼š' + (response.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        },
        error: function() {
            showTips('åˆ›å»ºå¯¹è¯å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    });
}

function createNewConversationAndSend(message) {
    // ä½¿ç”¨æ¶ˆæ¯çš„å‰20ä¸ªå­—ç¬¦ä½œä¸ºå¯¹è¯æ ‡é¢˜
    const title = message.length > 20 ? message.substring(0, 20) + '...' : message;
    
    $.ajax({
        url: '/api/conversations',
        method: 'POST',
        data: { title: title },
        success: function(response) {
            if (response.code === 200) {
                currentConversationId = response.data.conversation_id;
                $('#conversationTitle').text(title);
                loadConversations();
                
                // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
                $('#chatMessages').empty();
                $('#welcomeMessage').hide();
                
                // ç«‹å³å‘é€æ¶ˆæ¯
                sendMessage();
            } else {
                showTips('åˆ›å»ºå¯¹è¯å¤±è´¥ï¼š' + (response.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        },
        error: function() {
            showTips('åˆ›å»ºå¯¹è¯å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    });
}

function enableChat() {
    $('#messageInput').prop('disabled', false);
    $('#sendBtn').prop('disabled', false);
}



function checkUserAuth() {
    $.ajax({
        url: '/api/check-auth',
        method: 'GET',
        success: function(response) {
            if (response.code === 200 && response.data.authenticated) {
                $('#user-info').show();
                // ä¼˜å…ˆæ˜¾ç¤ºæ˜µç§°ï¼Œå¦‚æœæ²¡æœ‰æ˜µç§°åˆ™æ˜¾ç¤ºç”¨æˆ·å
                const displayName = response.data.display_name || response.data.username;
                $('#username-display').text(displayName);
                
                // å¦‚æœæ˜¯ç®¡ç†å‘˜æˆ–è¶…çº§ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºç®¡ç†é¢æ¿é“¾æ¥
                if (response.data.role === 'admin' || response.data.role === 'super_admin') {
                    if ($('#admin-link').length === 0) {
                        $('#user-info').append('<a href="/admin" id="admin-link" class="btn btn-sm btn-outline-primary ms-2"><i class="fas fa-cog me-1"></i>ç®¡ç†é¢æ¿</a>');
                    }
                }
            }
        },
        error: function() {
            console.log('ç”¨æˆ·æœªç™»å½•');
        }
    });
}

function setupLoginEvents() {
    // ç™»å½•æŒ‰é’®
    $('#loginBtn').click(function() {
        const username = $('#username').val();
        const password = $('#password').val();
        const remember = $('#remember').is(':checked');

        if (!username || !password) {
            showTips('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'warning');
            return;
        }

        $.ajax({
            url: '/login',
            method: 'POST',
            data: {
                username: username,
                password: password,
                remember: remember
            },
            success: function(response) {
                if (response.code === 200) {
                    $('#loginModal').modal('hide');
                    isGuest = false;
                    loadConversations();
                    checkUserAuth();
                    // å‘é€ä¹‹å‰è¾“å…¥çš„æ¶ˆæ¯
                    sendMessage();
                } else {
                    showTips(response.message || 'ç™»å½•å¤±è´¥', 'error');
                }
            },
            error: function() {
                showTips('ç™»å½•è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        });
    });

    // æ³¨å†ŒæŒ‰é’®
    $('#registerBtn').click(function() {
        $('#loginModal').modal('hide');
        $('#registerModal').modal('show');
    });

    // æ³¨å†Œæäº¤
    $('#submitRegisterBtn').click(function() {
        const username = $('#regUsername').val();
        const password = $('#regPassword').val();
        const confirmPassword = $('#confirmPassword').val();

        if (!username || !password || !confirmPassword) {
            showTips('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'warning');
            return;
        }

        if (password !== confirmPassword) {
            showTips('å¯†ç ä¸åŒ¹é…', 'warning');
            return;
        }

        $.ajax({
            url: '/register',
            method: 'POST',
            data: {
                username: username,
                password: password
            },
            success: function(response) {
                if (response.code === 200) {
                    $('#registerModal').modal('hide');
                    showTips('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•', 'success');
                    $('#loginModal').modal('show');
                } else {
                    showTips(response.message || 'æ³¨å†Œå¤±è´¥', 'error');
                }
            },
            error: function() {
                showTips('æ³¨å†Œè¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        });
    });

    // æ¸¸å®¢è®¿é—®
    $('#guestBtn').click(function() {
        $('#loginModal').modal('hide');
        isGuest = true;
        $('#conversationTitle').text('æ¸¸å®¢æ¨¡å¼');
        $('#chatSubtitle').text('æ¸¸å®¢è®¿é—® - æ•°æ®ä¸ä¼šä¿å­˜');
        // å‘é€ä¹‹å‰è¾“å…¥çš„æ¶ˆæ¯
        sendMessage();
    });
}

// æ¶ˆæ¯ç¼–è¾‘åŠŸèƒ½
$(document).on('click', '.edit-message-btn', function() {
    const messageDiv = $(this).closest('.message');
    const messageText = messageDiv.find('.message-text');
    const originalContent = $(this).data('original-content');
    
    // å¦‚æœå·²ç»åœ¨ç¼–è¾‘çŠ¶æ€ï¼Œåˆ™ä¸é‡å¤åˆ›å»ºç¼–è¾‘è¡¨å•
    if (messageDiv.find('.message-edit-form').length > 0) {
        return;
    }
    
    // åˆ›å»ºç¼–è¾‘è¡¨å•
    const editForm = $(`
        <div class="message-edit-form">
            <textarea class="message-edit-textarea" placeholder="ç¼–è¾‘æ‚¨çš„æ¶ˆæ¯...">${originalContent}</textarea>
            <div class="message-edit-actions">
                <button class="btn btn-sm btn-secondary cancel-edit-btn">å–æ¶ˆ</button>
                <button class="btn btn-sm btn-primary save-edit-btn">ä¿å­˜å¹¶é‡æ–°å‘é€</button>
            </div>
        </div>
    `);
    
    // éšè—åŸå§‹æ¶ˆæ¯æ–‡æœ¬
    messageText.hide();
    
    // æ·»åŠ ç¼–è¾‘è¡¨å•
    messageDiv.find('.message-content').append(editForm);
    
    // èšç„¦åˆ°æ–‡æœ¬æ¡†
    editForm.find('.message-edit-textarea').focus();
});

// å–æ¶ˆç¼–è¾‘
$(document).on('click', '.cancel-edit-btn', function() {
    const messageDiv = $(this).closest('.message');
    const messageText = messageDiv.find('.message-text');
    const editForm = messageDiv.find('.message-edit-form');
    
    // æ˜¾ç¤ºåŸå§‹æ¶ˆæ¯æ–‡æœ¬
    messageText.show();
    
    // ç§»é™¤ç¼–è¾‘è¡¨å•
    editForm.remove();
});

// ä¿å­˜ç¼–è¾‘å¹¶é‡æ–°å‘é€
$(document).on('click', '.save-edit-btn', function() {
    const messageDiv = $(this).closest('.message');
    const messageText = messageDiv.find('.message-text');
    const editForm = messageDiv.find('.message-edit-form');
    const newContent = editForm.find('.message-edit-textarea').val().trim();
    
    if (!newContent) {
        showTips('æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º', 'warning');
        return;
    }
    
    // æ›´æ–°æ¶ˆæ¯å†…å®¹
    messageText.text(newContent).show();
    
    // æ›´æ–°ç¼–è¾‘æŒ‰é’®çš„åŸå§‹å†…å®¹æ•°æ®
    messageDiv.find('.edit-message-btn').data('original-content', newContent);
    
    // ç§»é™¤ç¼–è¾‘è¡¨å•
    editForm.remove();
    
    // åˆ é™¤å½“å‰æ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆåŒ…æ‹¬AIå›å¤ï¼‰
    messageDiv.nextAll('.message').remove();
    
    // é‡æ–°å‘é€æ¶ˆæ¯
    if (currentConversationId || isGuest) {
        sendMessageWithContent(newContent);
    } else {
        // å¦‚æœæ²¡æœ‰å½“å‰å¯¹è¯ï¼Œåˆ›å»ºæ–°å¯¹è¯å¹¶å‘é€
        createNewConversationAndSend(newContent);
    }
    
    showTips('æ¶ˆæ¯å·²æ›´æ–°å¹¶é‡æ–°å‘é€', 'success');
});

// å‘é€æŒ‡å®šå†…å®¹çš„æ¶ˆæ¯
function sendMessageWithContent(content) {
    if (!content.trim()) return;
    
    // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
    $('#loadingIndicator').show();
    $('#sendBtn').prop('disabled', true);
    
    // åˆ›å»ºåŠ©æ‰‹æ¶ˆæ¯å®¹å™¨ï¼Œå‡†å¤‡æ¥æ”¶æµå¼è¾“å‡º
    const assistantMessageId = 'msg-' + Date.now();
    addStreamingMessage('assistant', '', assistantMessageId);
    
    // å‘é€æ¶ˆæ¯åˆ°åç«¯å¹¶æ¥æ”¶æµå¼å“åº”
    const endpoint = isGuest ? '/api/chat-guest-stream' : '/api/chat-stream';
    const data = isGuest ? { message: content } : { 
        message: content, 
        conversation_id: currentConversationId 
    };
    
    // ä½¿ç”¨fetch APIæ”¯æŒæµå¼å“åº”
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        function readStream() {
            return reader.read().then(({ done, value }) => {
                if (done) {
                    $('#loadingIndicator').hide();
                    $('#sendBtn').prop('disabled', false);
                    return;
                }
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // ä¿ç•™ä¸å®Œæ•´çš„è¡Œ
                
                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6);
                        if (data === '[DONE]') {
                            $('#loadingIndicator').hide();
                            $('#sendBtn').prop('disabled', false);
                            return;
                        }
                        
                        try {
                            const parsed = JSON.parse(data);
                            if (parsed.type === 'content') {
                                // æ£€æµ‹æ­¥éª¤ä¿¡æ¯å¹¶æ›´æ–°åŠ è½½æŒ‡ç¤ºå™¨
                                const stepMatch = parsed.content.match(/ğŸ“ \*\*æ­¥éª¤ (\d+):\*\*/);
                                if (stepMatch) {
                                    const stepNumber = stepMatch[1];
                                    $('#loadingIndicator p').text(`OpenManus æ­£åœ¨æ€è€ƒ... (æ­¥éª¤ ${stepNumber})`);
                                } else if (parsed.content.includes('ğŸ¤” å¼€å§‹æ€è€ƒ...')) {
                                    $('#loadingIndicator p').text('OpenManus æ­£åœ¨æ€è€ƒ... (åˆå§‹åŒ–)');
                                } else if (parsed.content.includes('âœ… **æœ€ç»ˆå›å¤:**')) {
                                    $('#loadingIndicator p').text('OpenManus æ­£åœ¨æ€è€ƒ... (ç”Ÿæˆå›å¤)');
                                }
                                
                                appendToStreamingMessage(assistantMessageId, parsed.content);
                            } else if (parsed.type === 'error') {
                                $('#loadingIndicator').hide();
                                $('#sendBtn').prop('disabled', false);
                                addMessage('system', 'æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼š' + parsed.message);
                                return;
                            } else if (parsed.type === 'done') {
                                 $('#loadingIndicator').hide();
                                 $('#sendBtn').prop('disabled', false);
                                 finalizeStreamingMessage(assistantMessageId);
                                 if (!isGuest && parsed.conversation_id) {
                                     currentConversationId = parsed.conversation_id;
                                     loadConversations();
                                 }
                                 return;
                             }
                        } catch (e) {
                            console.error('Error parsing SSE data:', e);
                        }
                    }
                });
                
                return readStream();
            });
        }
        
        return readStream();
    })
    .catch(error => {
        $('#loadingIndicator').hide();
        $('#sendBtn').prop('disabled', false);
        console.error('Fetch error:', error);
        addMessage('system', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
    });
}

</script>
{% endblock %}