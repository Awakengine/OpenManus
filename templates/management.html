{% extends "base.html" %}

{% block title %}管理设置 - OpenManus{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #e74c3c;
        --success-color: #27ae60;
        --warning-color: #f39c12;
        --dark-color: #34495e;
        --light-color: #ecf0f1;
        --border-color: #bdc3c7;
    }

    body {
        font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f8f9fa;
        color: var(--dark-color);
    }

    .management-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .tabs {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        border: 1px solid rgba(102, 126, 234, 0.1);
    }

    .tab-buttons {
        display: flex;
        background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
        border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        position: relative;
    }

    .tab-button {
        flex: 1;
        padding: 18px 25px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
        color: #6b7280;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .tab-button:hover {
        background: rgba(102, 126, 234, 0.05);
        color: #4f46e5;
        transform: translateY(-1px);
    }

    .tab-button.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-color: transparent;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        transform: translateY(-2px);
    }

    .tab-content {
        padding: 30px;
        background: linear-gradient(135deg, #fafbff 0%, #f8f9ff 100%);
        min-height: 400px;
    }

    .tab-pane {
        display: none;
    }

    .tab-pane.active {
        display: block;
        animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-transform: none;
        letter-spacing: normal;
    }

    .btn:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4c93 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn-danger {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.2);
    }

    .btn-danger:hover {
        background: linear-gradient(135deg, #ff5252 0%, #e53e3e 100%);
        box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        transform: translateY(-1px);
    }

    .btn-warning {
        background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(255, 167, 38, 0.2);
    }

    .btn-warning:hover {
        background: linear-gradient(135deg, #ff9500 0%, #f57c00 100%);
        box-shadow: 0 4px 12px rgba(255, 167, 38, 0.3);
        transform: translateY(-1px);
    }

    .btn-success {
        background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
    }

    .btn-success:hover {
        background: linear-gradient(135deg, #43a047 0%, #1b5e20 100%);
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        transform: translateY(-1px);
    }

    .btn-outline-secondary {
        border: 1px solid #6b7280;
        color: #6b7280;
        background: white;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 14px;
        transition: all 0.2s ease;
        box-shadow: none;
    }

    .btn-outline-secondary:hover {
        background: #6b7280;
        color: white;
        transform: translateY(-1px);
    }

    .btn-outline-info {
        border: 1px solid #06b6d4;
        color: #06b6d4;
        background: white;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 14px;
        transition: all 0.2s ease;
        box-shadow: none;
    }

    .btn-outline-info:hover {
        background: #06b6d4;
        color: white;
        transform: translateY(-1px);
    }

    .btn-xs {
        padding: 4px 8px !important;
        font-size: 12px !important;
        border-radius: 4px !important;
    }

    .config-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .config-selector {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .config-selector label {
        font-weight: bold;
        color: #333;
    }

    .config-selector select {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .refresh-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
    }

    .refresh-btn:hover {
        background: #5a6fd8;
    }

    .config-editor {
        background: white;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .config-file {
        margin-bottom: 20px;
    }

    .config-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
    }

    .config-header h4 {
        color: #333;
        margin: 0;
    }

    .file-type {
        color: #666;
        font-size: 12px;
        font-weight: normal;
    }

    .save-btn {
        background: #2ed573;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
    }

    .save-btn:hover {
        background: #26d467;
    }

    .config-textarea {
        width: 100%;
        min-height: 300px;
        padding: 15px;
        border: none;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 13px;
        line-height: 1.5;
        resize: vertical;
        outline: none;
    }

    .config-textarea:focus {
        outline: none;
        box-shadow: inset 0 0 0 2px #667eea;
    }

    .form-control {
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 14px;
        height: 32px;
        transition: all 0.2s ease;
        background-color: #ffffff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        outline: none;
        background-color: #fafbff;
    }

    .form-control:hover {
        border-color: #cbd5e0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        background: white;
    }

    .card-header {
        background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
        border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        border-radius: 12px 12px 0 0 !important;
        padding: 20px 25px;
    }

    .card-body {
        padding: 25px;
    }

    .alert {
        padding: 12px 16px;
        border-radius: 4px;
        margin-bottom: 15px;
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .loading {
        text-align: center;
        color: #666;
        padding: 20px;
    }

    .empty-state {
        text-align: center;
        color: #999;
        padding: 40px 20px;
        font-style: italic;
    }

    .table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 25px;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(102, 126, 234, 0.1);
    }

    .table th,
    .table td {
        padding: 16px 20px;
        text-align: left;
        border-bottom: 1px solid rgba(102, 126, 234, 0.08);
    }

    .table th {
        background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
        font-weight: 700;
        color: #4f46e5;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 13px;
        position: relative;
    }

    .table th::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .table tbody tr {
        transition: all 0.3s ease;
    }

    .table tbody tr:hover {
        background: linear-gradient(135deg, #fafbff 0%, #f8f9ff 100%);
        transform: scale(1.01);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
    }

    .table tbody tr:last-child td {
        border-bottom: none;
    }

    .search-section {
        background: white;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(102, 126, 234, 0.1);
    }

    .search-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .search-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr;
        gap: 15px;
        align-items: end;
    }

    .search-field {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .search-field .form-label {
        font-weight: 600;
        color: #4f46e5;
        margin: 0;
        font-size: 14px;
        display: flex;
        align-items: center;
    }

    .search-field .form-label i {
        color: #667eea;
    }

    .search-actions {
         display: flex;
         gap: 8px;
         justify-content: flex-end;
         align-items: center;
         padding-top: 8px;
         margin-top: 5px;
     }

     .search-btn {
         background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
         border: none;
         padding: 8px 16px;
         border-radius: 6px;
         font-weight: 500;
         font-size: 14px;
         transition: all 0.2s ease;
         box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
         color: white;
     }

     .search-btn:hover {
         transform: translateY(-1px);
         box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
     }

     .reset-btn {
         border: 1px solid #6b7280;
         color: #6b7280;
         background: white;
         padding: 8px 16px;
         border-radius: 6px;
         font-weight: 500;
         font-size: 14px;
         transition: all 0.2s ease;
     }

     .reset-btn:hover {
         background: #6b7280;
         color: white;
         transform: translateY(-1px);
     }

     .export-btn {
         border: 1px solid #06b6d4;
         color: #06b6d4;
         background: white;
         padding: 8px 16px;
         border-radius: 6px;
         font-weight: 500;
         font-size: 14px;
         transition: all 0.2s ease;
     }

     .export-btn:hover {
         background: #06b6d4;
         color: white;
         transform: translateY(-1px);
     }

     .import-btn {
         border: 1px solid #10b981;
         color: #10b981;
         background: white;
         padding: 8px 16px;
         border-radius: 6px;
         font-weight: 500;
         font-size: 14px;
         transition: all 0.2s ease;
     }

     .import-btn:hover {
         background: #10b981;
         color: white;
         transform: translateY(-1px);
     }

    @media (max-width: 1024px) {
        .search-row {
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
    }

    @media (max-width: 768px) {
         .search-row {
             grid-template-columns: 1fr;
             gap: 15px;
         }
         
         .search-actions {
             justify-content: center;
             flex-wrap: wrap;
         }
         
         .search-actions button {
             min-width: 80px;
         }
     }



    .role-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .role-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }

    .role-card.border-primary {
        border-color: #667eea;
    }

    .role-card.border-warning {
        border-color: #ffa726;
    }

    .role-card.border-danger {
        border-color: #ff6b6b;
    }

    /* 顶部提示框样式 */
    .tips-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        width: auto;
        max-width: 500px;
        min-width: 300px;
    }

    .tips-alert {
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 500;
        animation: slideDown 0.3s ease-out;
        border: none;
        position: relative;
        overflow: hidden;
    }

    .tips-alert::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: currentColor;
    }

    .tips-alert-success {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
        border-left: 4px solid #28a745;
    }

    .tips-alert-error {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        color: #721c24;
        border-left: 4px solid #dc3545;
    }

    .tips-alert-warning {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        color: #856404;
        border-left: 4px solid #ffc107;
    }

    .tips-alert-info {
        background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        color: #0c5460;
        border-left: 4px solid #17a2b8;
    }

    .tips-content {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
    }

    .tips-icon {
        font-size: 16px;
        margin-right: 4px;
    }

    .tips-close {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: inherit;
        opacity: 0.7;
        padding: 0;
        margin-left: 10px;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
    }

    .tips-close:hover {
        opacity: 1;
        background: rgba(0, 0, 0, 0.1);
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideUp {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(-20px);
        }
    }

    .tips-alert.removing {
        animation: slideUp 0.3s ease-out forwards;
    }
</style>
{% endblock %}

{% block content %}
<!-- 顶部提示框容器 -->
<div id="tipsContainer" class="tips-container"></div>

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-cogs me-2"></i>管理设置</h2>

            <div class="management-container">
                <div class="tabs">
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="switchTab('profile')">
                            <i class="fas fa-user me-2"></i>个人信息
                        </button>
                        {% if session.role in ['admin', 'super_admin', 'user_admin'] %}
                        <button class="tab-button" onclick="switchTab('users')">
                            <i class="fas fa-users me-2"></i>用户管理
                        </button>
                        {% endif %}
                        {% if session.role in ['super_admin', 'role_admin'] %}
                        <button class="tab-button" onclick="switchTab('roles')">
                            <i class="fas fa-user-shield me-2"></i>角色管理
                        </button>
                        {% endif %}
                        {% if session.role == 'super_admin' %}
                        <button class="tab-button" onclick="switchTab('config')">
                            <i class="fas fa-cogs me-2"></i>系统配置
                        </button>
                        {% endif %}
                    </div>

                    <div class="tab-content">
                        <!-- 个人信息标签页 -->
                        <div id="profile" class="tab-pane active">
                            <!-- 基本信息修改 -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-user me-2"></i>基本信息</h5>
                                </div>
                                <div class="card-body">
                                    <form id="profileForm">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="username" class="form-label">用户名</label>
                                                    <input type="text" class="form-control" id="username" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="nickname" class="form-label">昵称</label>
                                                    <input type="text" class="form-control" id="nickname" placeholder="请输入昵称">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="email" class="form-label">邮箱 <span class="text-danger">*</span></label>
                                                    <input type="email" class="form-control" id="email" required>
                                                </div>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-2"></i>保存基本信息
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <!-- 密码修改 -->
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-lock me-2"></i>修改密码</h5>
                                </div>
                                <div class="card-body">
                                    <form id="passwordForm">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="oldPassword" class="form-label">当前密码 <span class="text-danger">*</span></label>
                                                    <input type="password" class="form-control" id="oldPassword" required placeholder="请输入当前密码">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="newPassword" class="form-label">新密码 <span class="text-danger">*</span></label>
                                                    <input type="password" class="form-control" id="newPassword" required placeholder="请输入新密码（至少6位）">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="confirmPassword" class="form-label">确认密码 <span class="text-danger">*</span></label>
                                                    <input type="password" class="form-control" id="confirmPassword" required placeholder="请再次输入新密码">
                                                </div>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-warning">
                                            <i class="fas fa-key me-2"></i>修改密码
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        {% if session.role in ['admin', 'super_admin', 'user_admin'] %}
                        <!-- 用户管理标签页 -->
                        <div id="users" class="tab-pane">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3>用户管理</h3>
                                {% if session.role in ['super_admin', 'user_admin'] %}
                                <button class="btn btn-success" onclick="showCreateUserModal()">
                                    <i class="fas fa-plus me-1"></i>创建用户
                                </button>
                                {% endif %}
                            </div>
                            
                            <!-- 用户查询条件 -->
                            <div class="search-section">
                                <div class="search-container">
                                    <div class="search-row">
                                        <div class="search-field">
                                            <label for="userSearchKeyword" class="form-label">
                                                <i class="fas fa-search me-1"></i>关键词搜索
                                            </label>
                                            <input type="text" class="form-control" id="userSearchKeyword" placeholder="输入用户名或邮箱进行搜索...">
                                        </div>
                                        <div class="search-field">
                                            <label for="userRoleFilter" class="form-label">
                                                <i class="fas fa-user-tag me-1"></i>角色筛选
                                            </label>
                                            <select class="form-control" id="userRoleFilter">
                                                <option value="">全部角色</option>
                                                <!-- 角色选项将通过JavaScript动态加载 -->
                                            </select>
                                        </div>
                                        <div class="search-field">
                                            <label for="userStatusFilter" class="form-label">
                                                <i class="fas fa-toggle-on me-1"></i>状态筛选
                                            </label>
                                            <select class="form-control" id="userStatusFilter">
                                                <option value="">全部状态</option>
                                                <option value="active">启用</option>
                                                <option value="disabled">禁用</option>
                                            </select>
                                        </div>
                                        <div class="search-field">
                                            <label for="userDateFilter" class="form-label">
                                                <i class="fas fa-calendar me-1"></i>注册时间
                                            </label>
                                            <input type="date" class="form-control" id="userDateFilter">
                                        </div>
                                    </div>
                                    <div class="search-actions">
                                        <button class="btn btn-primary search-btn" onclick="searchUsers()">
                                            <i class="fas fa-search me-1"></i>搜索
                                        </button>
                                        <button class="btn btn-outline-secondary reset-btn" onclick="resetUserSearch()">
                                            <i class="fas fa-undo me-1"></i>重置
                                        </button>
                                        <button class="btn btn-outline-info export-btn" onclick="exportUsers()">
                                            <i class="fas fa-download me-1"></i>导出
                                        </button>
                                        <button class="btn btn-outline-success import-btn" onclick="document.getElementById('importFile').click()">
                                            <i class="fas fa-upload me-1"></i>导入
                                        </button>
                                        <input type="file" id="importFile" accept=".csv,.xlsx,.json" style="display: none;" onchange="importUsers(this)">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-striped" id="usersTable">
                                    <thead>
                                        <tr>
                                            <th>用户名</th>
                                            <th>昵称</th>
                                            <th>邮箱</th>
                                            <th>角色</th>
                                            <th>状态</th>
                                            <th>创建时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 用户数据将通过JavaScript加载 -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- 分页组件 -->
                            <div class="d-flex justify-content-between align-items-center mt-3" id="usersPagination" style="display: none !important;">
                                <div class="pagination-info">
                                    <span class="text-muted">显示第 <span id="usersStartIndex">1</span> - <span id="usersEndIndex">10</span> 条，共 <span id="usersTotalCount">0</span> 条记录</span>
                                </div>
                                <div class="pagination-controls d-flex align-items-center">
                                    <div class="btn-group me-3" role="group">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="usersPrevBtn" onclick="loadUsersPage(currentUsersPage - 1)" disabled>
                                            <i class="fas fa-chevron-left"></i> 上一页
                                        </button>
                                        <span class="btn btn-outline-secondary btn-sm disabled" id="usersPageInfo">第 1 页，共 1 页</span>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="usersNextBtn" onclick="loadUsersPage(currentUsersPage + 1)" disabled>
                                            下一页 <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                    <select class="btn btn-outline-secondary btn-sm" id="usersPageSize" onchange="changeUsersPageSize(this.value)" style="width: auto; height: auto; border: 1px solid #6c757d; background-color: white; color: #495057 !important; cursor: pointer;">
                                        <style>
                                            #usersPageSize option {
                                                color: #495057 !important;
                                                background-color: white !important;
                                            }
                                            #usersPageSize:focus {
                                                color: #495057 !important;
                                                background-color: white !important;
                                            }
                                        </style>
                                        <option value="10">每页 10 条</option>
                                        <option value="20">每页 20 条</option>
                                        <option value="50">每页 50 条</option>
                                        <option value="100">每页 100 条</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if session.role in ['super_admin', 'role_admin'] %}
                        <!-- 角色管理标签页 -->
                        <div id="roles" class="tab-pane">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3>角色管理</h3>
                                {% if session.role == 'super_admin' %}
                                <button class="btn btn-success" onclick="showCreateRoleModal()">
                                    <i class="fas fa-plus me-1"></i>创建角色
                                </button>
                                {% endif %}
                            </div>
                            
                            <!-- 角色查询条件 -->
                            <div class="search-section">
                                <div class="search-container">
                                    <div class="search-row">
                                        <div class="search-field">
                                            <label for="roleNameFilter" class="form-label">
                                                <i class="fas fa-tag me-1"></i>角色名称
                                            </label>
                                            <input type="text" class="form-control" id="roleNameFilter" placeholder="输入角色名称...">
                                        </div>
                                        <div class="search-field">
                                            <label for="roleDisplayNameFilter" class="form-label">
                                                <i class="fas fa-user-tag me-1"></i>显示名称
                                            </label>
                                            <input type="text" class="form-control" id="roleDisplayNameFilter" placeholder="输入显示名称...">
                                        </div>
                                        <div class="search-field">
                                            <label for="roleDescriptionFilter" class="form-label">
                                                <i class="fas fa-file-text me-1"></i>描述
                                            </label>
                                            <input type="text" class="form-control" id="roleDescriptionFilter" placeholder="输入描述内容...">
                                        </div>
                                        <div class="search-field">
                                            <label for="roleCreatedDateFilter" class="form-label">
                                                <i class="fas fa-calendar me-1"></i>创建时间
                                            </label>
                                            <input type="date" class="form-control" id="roleCreatedDateFilter">
                                        </div>
                                    </div>
                                    <div class="search-actions">
                                        <button class="btn btn-primary search-btn" onclick="searchRoles()">
                                            <i class="fas fa-search me-1"></i>搜索
                                        </button>
                                        <button class="btn btn-outline-secondary reset-btn" onclick="resetRoleSearch()">
                                            <i class="fas fa-undo me-1"></i>重置
                                        </button>
                                        <button class="btn btn-outline-info export-btn" onclick="exportRoles()">
                                            <i class="fas fa-download me-1"></i>导出
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-striped" id="rolesTable">
                                    <thead>
                                        <tr>
                                            <th>角色名称</th>
                                            <th>显示名称</th>
                                            <th>描述</th>
                                            <th>创建时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 角色数据将通过JavaScript加载 -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- 分页组件 -->
                            <div class="d-flex justify-content-between align-items-center mt-3" id="rolesPagination" style="display: none !important;">
                                <div class="pagination-info">
                                    <span class="text-muted">显示第 <span id="rolesStartIndex">1</span> - <span id="rolesEndIndex">10</span> 条，共 <span id="rolesTotalCount">0</span> 条记录</span>
                                </div>
                                <div class="pagination-controls d-flex align-items-center">
                                    <div class="btn-group me-3" role="group">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="rolesPrevBtn" onclick="loadRolesPage(currentRolesPage - 1)" disabled>
                                            <i class="fas fa-chevron-left"></i> 上一页
                                        </button>
                                        <span class="btn btn-outline-secondary btn-sm disabled" id="rolesPageInfo">第 1 页，共 1 页</span>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="rolesNextBtn" onclick="loadRolesPage(currentRolesPage + 1)" disabled>
                                            下一页 <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                    <select class="btn btn-outline-secondary btn-sm" id="rolesPageSize" onchange="changeRolesPageSize(this.value)" style="width: auto; height: auto; border: 1px solid #6c757d; background-color: white; color: #495057 !important; cursor: pointer;">
                                        <style>
                                            #rolesPageSize option {
                                                color: #495057 !important;
                                                background-color: white !important;
                                            }
                                            #rolesPageSize:focus {
                                                color: #495057 !important;
                                                background-color: white !important;
                                            }
                                        </style>
                                        <option value="10">每页 10 条</option>
                                        <option value="20">每页 20 条</option>
                                        <option value="50">每页 50 条</option>
                                        <option value="100">每页 100 条</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if session.role == 'super_admin' %}
                        <!-- 系统配置标签页 -->
                        <div id="config" class="tab-pane">
                            <h3>系统配置</h3>
                            <div class="config-section">
                                <div class="config-selector">
                                    <label for="config-file-select">选择配置文件:</label>
                                    <select id="config-file-select" onchange="loadSelectedConfig()">
                                        <option value="">请选择配置文件...</option>
                                    </select>
                                    <button class="refresh-btn" onclick="refreshConfigList()">刷新列表</button>
                                </div>
                                <div class="config-editor" id="config-editor">
                                    <div class="empty-state">请从上方下拉框中选择要编辑的配置文件</div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 创建用户模态框 -->
{% if session.role in ['super_admin', 'user_admin'] %}
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">创建新用户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="mb-3">
                        <label for="newUsername" class="form-label">用户名</label>
                        <input type="text" class="form-control" id="newUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="newUserEmail" class="form-label">邮箱</label>
                        <input type="email" class="form-control" id="newUserEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="newUserPassword" class="form-label">密码</label>
                        <input type="password" class="form-control" id="newUserPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="newUserRole" class="form-label">角色</label>
                        <select class="form-control" id="newUserRole" required>
                            <!-- 角色选项将通过JavaScript动态加载 -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="createUser()">创建</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // 顶部提示框功能
    function showTips(message, type = 'info', duration = 3000) {
        const container = document.getElementById('tipsContainer');
        if (!container) return;
        
        // 创建提示框元素
        const alert = document.createElement('div');
        alert.className = `tips-alert tips-alert-${type}`;
        
        // 根据类型设置图标
        let icon = '';
        switch(type) {
            case 'success':
                icon = '✓';
                break;
            case 'error':
                icon = '✗';
                break;
            case 'warning':
                icon = '⚠';
                break;
            case 'info':
            default:
                icon = 'ℹ';
                break;
        }
        
        alert.innerHTML = `
            <div class="tips-content">
                <span class="tips-icon">${icon}</span>
                <span class="tips-message">${message}</span>
            </div>
            <button class="tips-close" onclick="closeTips(this)">&times;</button>
        `;
        
        // 添加到容器
        container.appendChild(alert);
        
        // 自动关闭
        if (duration > 0) {
            setTimeout(() => {
                closeTips(alert.querySelector('.tips-close'));
            }, duration);
        }
        
        return alert;
    }
    
    // 关闭提示框
    function closeTips(closeBtn) {
        const alert = closeBtn.closest('.tips-alert');
        if (alert) {
            alert.classList.add('removing');
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 300);
        }
    }
    
    // 清除所有提示框
    function clearAllTips() {
        const container = document.getElementById('tipsContainer');
        if (container) {
            container.innerHTML = '';
        }
    }
    
    // 确认对话框函数
    function showConfirm(message) {
        return new Promise((resolve) => {
            const container = document.getElementById('tipsContainer');
            if (!container) {
                resolve(confirm(message)); // 降级到原生confirm
                return;
            }
            
            // 创建确认对话框
            const confirmBox = document.createElement('div');
            confirmBox.className = 'tips-alert tips-alert-warning';
            confirmBox.style.maxWidth = '400px';
            
            confirmBox.innerHTML = `
                <div class="tips-content">
                    <span class="tips-icon">⚠</span>
                    <span class="tips-message">${message}</span>
                </div>
                <div style="margin-left: 10px; display: flex; gap: 8px;">
                    <button class="btn btn-sm btn-danger" onclick="confirmAction(true, this)">确定</button>
                    <button class="btn btn-sm btn-secondary" onclick="confirmAction(false, this)">取消</button>
                </div>
            `;
            
            // 添加到容器
            container.appendChild(confirmBox);
            
            // 设置全局回调
            window.currentConfirmResolve = resolve;
        });
    }
    
    // 确认操作回调
    function confirmAction(result, button) {
        const confirmBox = button.closest('.tips-alert');
        if (confirmBox) {
            confirmBox.classList.add('removing');
            setTimeout(() => {
                if (confirmBox.parentNode) {
                    confirmBox.parentNode.removeChild(confirmBox);
                }
            }, 300);
        }
        
        if (window.currentConfirmResolve) {
            window.currentConfirmResolve(result);
            window.currentConfirmResolve = null;
        }
    }

    // 标签页切换功能
    function switchTab(tabName) {
        // 隐藏所有标签页内容
        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('active');
        });
        
        // 移除所有按钮的活跃状态
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });
        
        // 显示选中的标签页
        document.getElementById(tabName).classList.add('active');
        
        // 激活对应的按钮
        if (event && event.target) {
            event.target.classList.add('active');
        } else {
            // 如果没有event对象，通过tabName找到对应按钮
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => {
                if (button.getAttribute('onclick').includes(tabName)) {
                    button.classList.add('active');
                }
            });
        }
        
        // 保存当前选择的tab到localStorage
        localStorage.setItem('activeTab', tabName);
        
        // 根据标签页加载相应数据
        if (tabName === 'users') {
            // 先加载角色数据，然后初始化用户管理页面
            loadAllRoles().then(() => {
                // 初始化用户筛选的角色下拉框
                const userRoleFilter = document.getElementById('userRoleFilter');
                if (userRoleFilter) {
                    renderRoleOptions(userRoleFilter, '', true); // 包含"全部角色"选项
                }
                
                // 初始化创建用户的角色下拉框
                const newUserRole = document.getElementById('newUserRole');
                if (newUserRole) {
                    renderRoleOptions(newUserRole);
                }
                
                // 加载用户列表
                loadUsers();
            });
        } else if (tabName === 'config') {
            loadConfigs();
        }
    }

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function () {
        loadUserProfile();
        
        // 恢复上次选择的tab，默认为profile
        const activeTab = localStorage.getItem('activeTab') || 'profile';
        if (activeTab !== 'profile') {
            switchTab(activeTab);
        }
        
        // 如果当前激活的是用户管理tab，确保加载用户数据
        if (activeTab === 'users') {
            // 先加载角色数据，然后初始化用户管理页面
            loadAllRoles().then(() => {
                // 初始化用户筛选的角色下拉框
                const userRoleFilter = document.getElementById('userRoleFilter');
                if (userRoleFilter) {
                    renderRoleOptions(userRoleFilter, '', true); // 包含"全部角色"选项
                }
                
                // 初始化创建用户的角色下拉框
                const newUserRole = document.getElementById('newUserRole');
                if (newUserRole) {
                    renderRoleOptions(newUserRole);
                }
                
                // 加载用户列表
                loadUsers();
            });
        }
        
        // 保存基本信息
        document.getElementById('profileForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const nickname = document.getElementById('nickname').value;

            // 表单验证
            if (!email) {
                showTips('邮箱不能为空', 'warning');
                return;
            }

            const formData = {
                email: email,
                nickname: nickname
            };

            fetch('/api/profile/basic', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络请求失败: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.code === 200) {
                        showTips('基本信息更新成功！', 'success');
                    } else {
                        showTips('更新失败: ' + (data.message || '未知错误'), 'error');
                    }
                })
                .catch(error => {
                    console.error('更新失败:', error);
                    showTips('更新失败，请稍后重试', 'error');
                });
        });

        // 修改密码
        document.getElementById('passwordForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const oldPassword = document.getElementById('oldPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        // 表单验证
        if (!oldPassword) {
            showTips('请输入当前密码', 'warning');
            return;
        }

        if (!newPassword) {
            showTips('请输入新密码', 'warning');
            return;
        }

        if (newPassword.length < 6) {
            showTips('新密码长度至少6位', 'warning');
            return;
        }

        if (!confirmPassword) {
            showTips('请确认新密码', 'warning');
            return;
        }

        if (newPassword !== confirmPassword) {
            showTips('新密码与确认密码不一致', 'warning');
            return;
        }

        const formData = {
            currentPassword: oldPassword,
            newPassword: newPassword
        };

        fetch('/api/profile/password', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
            .then(response => {
                return response.json().then(data => {
                    if (!response.ok) {
                        throw new Error(data.error || '网络请求失败: ' + response.status);
                    }
                    return data;
                });
            })
            .then(data => {
                if (data.code === 200) {
                    showTips('密码修改成功！请重新登录。', 'success');
                    document.getElementById('oldPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    
                    // 如果后端返回logout标志，跳转到登录页面
                    if (data.data && data.data.logout) {
                        window.location.href = '/login';
                    }
                } else {
                    showTips('修改失败: ' + (data.message || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('修改失败:', error);
                showTips('修改失败: ' + error.message, 'error');
            });
        });
    });

    // 加载用户个人信息
    function loadUserProfile() {
        fetch('/api/profile')
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络请求失败: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 200) {
                    document.getElementById('username').value = data.data.username;
                    document.getElementById('email').value = data.data.email;
                    document.getElementById('nickname').value = data.data.nickname || '';
                } else {
                    showTips('加载用户信息失败: ' + (data.message || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('加载用户信息失败:', error);
                showTips('加载用户信息失败，请稍后重试', 'error');
            });
    }

    {% if session.role in ['admin', 'super_admin', 'user_admin'] %}
    // 分页相关全局变量
    let currentUsersPage = 1;
    let usersPageSize = 10;
    let usersTotalPages = 1;
    let usersTotalCount = 0;
    let currentUsersSearchParams = {};
    
    // 加载用户列表
    function loadUsers() {
        loadUsersPage(1);
    }
    
    // 加载指定页的用户数据
    function loadUsersPage(page) {
        if (page < 1 || page > usersTotalPages) return;
        
        currentUsersPage = page;
        
        // 构建查询参数
        const params = new URLSearchParams(currentUsersSearchParams);
        params.append('page', page);
        params.append('page_size', usersPageSize);
        
        const url = '/admin/users' + (params.toString() ? '?' + params.toString() : '');
        
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络请求失败: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.code !== 200) {
                    showTips('加载用户列表失败: ' + data.message, 'error');
                    return;
                }
                
                // 处理分页数据
                const responseData = data.data || {};
                const users = Array.isArray(responseData.users) ? responseData.users : 
                             Array.isArray(responseData) ? responseData : [];
                
                // 更新分页信息
                if (responseData.total !== undefined) {
                    usersTotalCount = responseData.total;
                    usersTotalPages = Math.ceil(usersTotalCount / usersPageSize);
                } else {
                    // 兼容旧接口，如果没有分页信息，则假设只有一页
                    usersTotalCount = users.length;
                    usersTotalPages = 1;
                }
                
                // 渲染用户表格
                renderUsersTable(users);
                
                // 更新分页组件
                updateUsersPagination();
            })
            .catch(error => {
                console.error('加载用户列表失败:', error);
                showTips('加载用户列表失败，请稍后重试', 'error');
            });
    }
    
    // 渲染用户表格
    function renderUsersTable(users) {
        const tbody = document.querySelector('#usersTable tbody');
        tbody.innerHTML = '';

        users.forEach(user => {
            const row = document.createElement('tr');
            const canModifyRole = '{{ session.role }}' === 'super_admin' || '{{ session.role }}' === 'role_admin';
            const canModifyUser = '{{ session.role }}' === 'super_admin' || '{{ session.role }}' === 'user_admin';
            
            let roleSelect = '';
            if (canModifyRole) {
                // 构建角色下拉框选项
                let roleOptions = '';
                allRoles.forEach(role => {
                    const selected = user.role === role.name ? 'selected' : '';
                    roleOptions += `<option value="${role.name}" ${selected}>${role.display_name}</option>`;
                });
                
                roleSelect = `
                    <select class="form-select form-select-sm" onchange="updateUserRole(${user.id}, this.value)">
                        ${roleOptions}
                    </select>
                `;
            } else {
                // 显示角色显示名称
                const userRole = allRoles.find(role => role.name === user.role);
                roleSelect = userRole ? userRole.display_name : user.role;
            }
            
            let actionButtons = '';
            if (canModifyUser) {
                actionButtons = `
                    <button class="btn btn-xs ${user.is_active ? 'btn-warning' : 'btn-success'}"
                            onclick="toggleUserStatus(${user.id}, ${!user.is_active})"
                            style="padding: 4px 8px; font-size: 12px; margin-right: 4px;">
                        ${user.is_active ? '禁用' : '启用'}
                    </button>
                    <button class="btn btn-xs btn-danger"
                            onclick="deleteUser(${user.id})"
                            style="padding: 4px 8px; font-size: 12px;">
                        删除
                    </button>
                `;
            }
            
            row.innerHTML = `
                <td>${user.username}</td>
                <td>${user.nickname || '-'}</td>
                <td>${user.email}</td>
                <td>${roleSelect}</td>
                <td>
                    <span class="badge ${user.is_active ? 'bg-success' : 'bg-secondary'}">
                        ${user.is_active ? '活跃' : '禁用'}
                    </span>
                </td>
                <td>${user.created_at || 'N/A'}</td>
                <td>${actionButtons}</td>
            `;
            tbody.appendChild(row);
        });
    }
    
    // 更新分页组件
    function updateUsersPagination() {
        const paginationDiv = document.getElementById('usersPagination');
        const startIndex = (currentUsersPage - 1) * usersPageSize + 1;
        const endIndex = Math.min(currentUsersPage * usersPageSize, usersTotalCount);
        
        // 更新分页信息
        document.getElementById('usersStartIndex').textContent = usersTotalCount > 0 ? startIndex : 0;
        document.getElementById('usersEndIndex').textContent = endIndex;
        document.getElementById('usersTotalCount').textContent = usersTotalCount;
        document.getElementById('usersPageInfo').textContent = `第 ${currentUsersPage} 页，共 ${usersTotalPages} 页`;
        
        // 更新按钮状态
        document.getElementById('usersPrevBtn').disabled = currentUsersPage <= 1;
        document.getElementById('usersNextBtn').disabled = currentUsersPage >= usersTotalPages;
        
        // 显示或隐藏分页组件
        if (usersTotalCount > usersPageSize) {
            paginationDiv.style.display = 'flex';
        } else {
            paginationDiv.style.display = 'none';
        }
    }
    
    // 改变每页显示数量
    function changeUsersPageSize(newPageSize) {
        usersPageSize = parseInt(newPageSize);
        currentUsersPage = 1;
        loadUsersPage(1);
    }

    // 搜索用户
    function searchUsers() {
        // 获取搜索条件
        const keyword = document.getElementById('userSearchKeyword').value.trim();
        const role = document.getElementById('userRoleFilter').value;
        const status = document.getElementById('userStatusFilter').value;
        const date = document.getElementById('userDateFilter').value;
        
        // 保存搜索参数
        currentUsersSearchParams = {};
        if (keyword) currentUsersSearchParams.keyword = keyword;
        if (role) currentUsersSearchParams.role = role;
        if (status) currentUsersSearchParams.status = status;
        if (date) currentUsersSearchParams.date = date;
        
        // 重置到第一页并执行搜索
        currentUsersPage = 1;
        loadUsersPage(1);
    }

    // 重置用户搜索
    function resetUserSearch() {
        document.getElementById('userSearchKeyword').value = '';
        document.getElementById('userRoleFilter').value = '';
        document.getElementById('userStatusFilter').value = '';
        document.getElementById('userDateFilter').value = '';
        
        // 清空搜索参数
        currentUsersSearchParams = {};
        
        // 重置分页并加载数据
        currentUsersPage = 1;
        loadUsers();
    }

    {% if session.role in ['super_admin', 'user_admin'] %}
    // 显示创建用户模态框
    function showCreateUserModal() {
        const modal = new bootstrap.Modal(document.getElementById('createUserModal'));
        modal.show();
    }

    // 创建用户
    function createUser() {
        const formData = {
            username: document.getElementById('newUsername').value,
            email: document.getElementById('newUserEmail').value,
            password: document.getElementById('newUserPassword').value,
            role: document.getElementById('newUserRole').value
        };

        fetch('/admin/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    showTips('用户创建成功！', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                    document.getElementById('createUserForm').reset();
                    loadUsersPage(currentUsersPage);
                } else {
                    showTips('创建失败: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('创建用户失败:', error);
                showTips('创建失败，请稍后重试', 'error');
            });
    }
    {% endif %}

    {% if session.role in ['super_admin', 'role_admin'] %}
    // 更新用户角色
    function updateUserRole(userId, newRole) {
        fetch(`/admin/users/${userId}/role`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ role: newRole })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络请求失败: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 200) {
                    showTips('角色更新成功！', 'success');
                } else {
                    showTips('更新失败: ' + (data.message || '未知错误'), 'error');
                    loadUsersPage(currentUsersPage); // 重新加载以恢复原状态
                }
            })
            .catch(error => {
                console.error('更新角色失败:', error);
                showTips('更新角色失败，请稍后重试', 'error');
                loadUsersPage(currentUsersPage);
            });
    }
    {% endif %}

    {% if session.role in ['super_admin', 'user_admin'] %}
    // 切换用户状态
    function toggleUserStatus(userId, isActive) {
        fetch(`/admin/users/${userId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_active: isActive })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络请求失败: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 200) {
                    showTips(`用户已${isActive ? '启用' : '禁用'}！`, 'success');
                    loadUsersPage(currentUsersPage);
                } else {
                    showTips('操作失败: ' + (data.message || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('操作失败:', error);
                showTips('切换用户状态失败，请稍后重试', 'error');
            });
    }

    // 删除用户
    async function deleteUser(userId) {
        const confirmed = await showConfirm('确定要删除该用户吗？此操作不可撤销！');
        if (confirmed) {
            fetch(`/admin/users/${userId}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络请求失败: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.code === 200) {
                        showTips('用户删除成功！', 'success');
                        // 如果当前页没有数据了，回到上一页
                        const remainingUsers = usersTotalCount - 1;
                        const maxPage = Math.ceil(remainingUsers / usersPageSize);
                        if (currentUsersPage > maxPage && maxPage > 0) {
                            loadUsersPage(maxPage);
                        } else {
                            loadUsersPage(currentUsersPage);
                        }
                    } else {
                        showTips('删除失败: ' + (data.message || '未知错误'), 'error');
                    }
                })
                .catch(error => {
                    console.error('删除失败:', error);
                    showTips('删除用户失败，请稍后重试', 'error');
                });
        }
    }

    // 导出用户数据
    function exportUsers() {
        // 获取当前搜索条件
        const keyword = document.getElementById('userSearchKeyword').value;
        const role = document.getElementById('userRoleFilter').value;
        const status = document.getElementById('userStatusFilter').value;
        const date = document.getElementById('userDateFilter').value;
        
        // 构建查询参数
        const params = new URLSearchParams();
        if (keyword) params.append('keyword', keyword);
        if (role) params.append('role', role);
        if (status) params.append('status', status);
        if (date) params.append('date', date);
        
        // 发起导出请求
        fetch(`/admin/users/export?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络请求失败: ' + response.status);
                }
                return response.blob();
            })
            .then(blob => {
                // 创建下载链接
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `users_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('导出失败:', error);
                alert('导出用户数据失败，请稍后重试');
            });
    }

    // 导入用户数据
    function importUsers(input) {
        const file = input.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/admin/users/import', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络请求失败: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 200) {
                    alert(`导入成功！共导入 ${data.data.imported} 个用户，跳过 ${data.data.skipped} 个重复用户`);
                    loadUsersPage(currentUsersPage);
                } else {
                    alert('导入失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                console.error('导入失败:', error);
                alert('导入用户数据失败，请稍后重试');
            })
            .finally(() => {
                // 清空文件输入
                input.value = '';
            });
    }
    {% endif %}

    {% if session.role == 'super_admin' %}
    // 加载配置文件列表
    function loadConfigs() {
        fetch('/admin/config')
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络请求失败: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.code !== 200) {
                    document.getElementById('config-editor').innerHTML = `<div class="alert alert-error">${data.message}</div>`;
                    alert('加载配置文件列表失败: ' + data.message);
                    return;
                }
                
                const select = document.getElementById('config-file-select');
                select.innerHTML = '<option value="">请选择配置文件...</option>';
                
                data.data.files.forEach(filename => {
                    const option = document.createElement('option');
                    option.value = filename;
                    option.textContent = filename;
                    select.appendChild(option);
                });
                
                document.getElementById('config-editor').innerHTML = '<div class="empty-state">请从上方下拉框中选择要编辑的配置文件</div>';
            })
            .catch(error => {
                console.error('加载配置文件列表失败:', error);
                document.getElementById('config-editor').innerHTML = '<div class="alert alert-error">加载配置文件列表失败</div>';
                alert('加载配置文件列表失败，请稍后重试');
            });
    }

    // 刷新配置文件列表
    function refreshConfigList() {
        loadConfigs();
    }

    // 加载选中的配置文件
    function loadSelectedConfig() {
        const filename = document.getElementById('config-file-select').value;
        
        if (!filename) {
            document.getElementById('config-editor').innerHTML = '<div class="empty-state">请从上方下拉框中选择要编辑的配置文件</div>';
            return;
        }

        fetch(`/admin/config/${filename}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络请求失败: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.code !== 200) {
                    document.getElementById('config-editor').innerHTML = `<div class="alert alert-error">${data.message}</div>`;
                    alert('加载配置文件失败: ' + data.message);
                    return;
                }

                const editor = document.getElementById('config-editor');
                const fileType = filename.split('.').pop();
                
                let content = data.data.content;
                
                // 如果是JSON文件，尝试格式化
                if (fileType === 'json') {
                    try {
                        const parsed = JSON.parse(content);
                        content = JSON.stringify(parsed, null, 2);
                    } catch (e) {
                        // 如果解析失败，保持原内容
                    }
                }

                const configTitle = `${filename} <span class="file-type">(${fileType.toUpperCase()})</span>`;

                editor.innerHTML = `
                    <div class="config-file">
                        <div class="config-header">
                            <h4>${configTitle}</h4>
                            <button class="save-btn" onclick="saveConfig('${filename}')">
                                <i class="fas fa-save me-1"></i>保存配置
                            </button>
                        </div>
                        <textarea class="config-textarea ${fileType === 'toml' ? 'config-toml-textarea' : ''}" 
                                  id="config-content-${filename.replace(/[^a-zA-Z0-9]/g, '_')}">${content}</textarea>
                    </div>
                `;
            })
            .catch(error => {
                console.error('加载配置文件失败:', error);
                document.getElementById('config-editor').innerHTML = '<div class="alert alert-error">加载配置文件失败</div>';
                alert('加载配置文件失败，请稍后重试');
            });
    }

    // 保存配置文件
    function saveConfig(filename) {
        const textareaId = `config-content-${filename.replace(/[^a-zA-Z0-9]/g, '_')}`;
        const content = document.getElementById(textareaId).value;
        
        fetch(`/admin/config/${filename}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content: content })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络请求失败: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 200) {
                    showTips('配置文件保存成功！', 'success');
                } else {
                    showTips('保存失败: ' + (data.message || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('保存配置文件失败:', error);
                showTips('保存配置文件失败，请稍后重试', 'error');
            });
    }
    {% endif %}
    
    // 角色管理相关功能
    {% if session.role in ['admin', 'super_admin', 'role_admin'] %}
    // 分页相关全局变量
    let currentRolesPage = 1;
    let rolesPageSize = 9; // 每页显示9个角色卡片（3行x3列）
    let rolesTotalPages = 1;
    let rolesTotalCount = 0;
    let currentRolesSearchParams = {};
    
    // 全局角色数据缓存
    let allRoles = [];
    
    // 加载所有角色数据（用于下拉框）
    function loadAllRoles() {
        return fetch('/admin/roles?page=1&page_size=1000') // 获取大量数据确保包含所有角色
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络请求失败: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 200) {
                    allRoles = data.data.roles || [];
                    return allRoles;
                } else {
                    throw new Error(data.message || '获取角色数据失败');
                }
            })
            .catch(error => {
                console.error('加载角色数据失败:', error);
                allRoles = [];
                return [];
            });
    }
    
    // 渲染角色下拉框选项
    function renderRoleOptions(selectElement, selectedValue = '', includeAllOption = false) {
        if (!selectElement) return;
        
        selectElement.innerHTML = '';
        
        if (includeAllOption) {
            const allOption = document.createElement('option');
            allOption.value = '';
            allOption.textContent = '全部角色';
            selectElement.appendChild(allOption);
        }
        
        allRoles.forEach(role => {
            const option = document.createElement('option');
            option.value = role.name;
            option.textContent = role.display_name;
            if (role.name === selectedValue) {
                option.selected = true;
            }
            selectElement.appendChild(option);
        });
    }
    
    // 搜索角色
    function searchRoles() {
        const roleName = document.getElementById('roleNameFilter').value.trim();
        const roleDisplayName = document.getElementById('roleDisplayNameFilter').value.trim();
        const roleDescription = document.getElementById('roleDescriptionFilter').value.trim();
        const createdDate = document.getElementById('roleCreatedDateFilter').value;
        
        currentRolesSearchParams = {};
        if (roleName) {
            currentRolesSearchParams.role_name = roleName;
        }
        if (roleDisplayName) {
            currentRolesSearchParams.display_name = roleDisplayName;
        }
        if (roleDescription) {
            currentRolesSearchParams.description = roleDescription;
        }
        if (createdDate) {
            currentRolesSearchParams.created_date = createdDate;
        }
        
        loadRolesPage(1);
    }
    
    // 重置角色搜索
    function resetRoleSearch() {
        currentRolesSearchParams = {};
        document.getElementById('roleNameFilter').value = '';
        document.getElementById('roleDisplayNameFilter').value = '';
        document.getElementById('roleDescriptionFilter').value = '';
        document.getElementById('roleCreatedDateFilter').value = '';
        loadRolesPage(1);
    }
    
    // 导出角色数据
    function exportRoles() {
        const roleName = document.getElementById('roleNameFilter').value;
        const roleDisplayName = document.getElementById('roleDisplayNameFilter').value;
        const roleDescription = document.getElementById('roleDescriptionFilter').value;
        const createdDate = document.getElementById('roleCreatedDateFilter').value;
        
        const params = new URLSearchParams();
        if (roleName) params.append('role_name', roleName);
        if (roleDisplayName) params.append('display_name', roleDisplayName);
        if (roleDescription) params.append('description', roleDescription);
        if (createdDate) params.append('created_date', createdDate);
        
        fetch(`/admin/roles/export?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络请求失败: ' + response.status);
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `roles_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('导出失败:', error);
                showTips('导出角色数据失败，请稍后重试', 'error');
            });
    }
    
    // 改变角色分页大小
    function changeRolesPageSize(newSize) {
        rolesPageSize = parseInt(newSize);
        loadRolesPage(1);
    }
    
    // 支持回车键搜索
    document.addEventListener('DOMContentLoaded', function() {
        const searchFields = ['roleNameFilter', 'roleDisplayNameFilter', 'roleDescriptionFilter', 'roleCreatedDateFilter'];
        searchFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchRoles();
                    }
                });
            }
        });
    });
    
    // 加载角色列表
    function loadRoles() {
        loadRolesPage(1);
    }
    
    // 加载指定页的角色数据
    function loadRolesPage(page) {
        if (page < 1 || page > rolesTotalPages) return;
        
        currentRolesPage = page;
        
        // 构建查询参数
        const params = new URLSearchParams();
        params.append('page', page);
        params.append('page_size', rolesPageSize);
        
        // 添加搜索参数
        if (currentRolesSearchParams.role_name) {
            params.append('role_name', currentRolesSearchParams.role_name);
        }
        if (currentRolesSearchParams.display_name) {
            params.append('display_name', currentRolesSearchParams.display_name);
        }
        if (currentRolesSearchParams.description) {
            params.append('description', currentRolesSearchParams.description);
        }
        if (currentRolesSearchParams.created_date) {
            params.append('created_date', currentRolesSearchParams.created_date);
        }
        
        const url = '/admin/roles' + (params.toString() ? '?' + params.toString() : '');
        
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络请求失败: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.code !== 200) {
                    showTips('加载角色列表失败: ' + data.message, 'error');
                    return;
                }
                
                // 处理分页数据
                const responseData = data.data || {};
                const roles = Array.isArray(responseData.roles) ? responseData.roles : 
                             Array.isArray(responseData) ? responseData : [];
                
                // 更新分页信息
                if (responseData.total !== undefined) {
                    rolesTotalCount = responseData.total;
                    rolesTotalPages = Math.ceil(rolesTotalCount / rolesPageSize);
                } else {
                    // 兼容旧接口，如果没有分页信息，则假设只有一页
                    rolesTotalCount = roles.length;
                    rolesTotalPages = 1;
                }
                
                // 渲染角色列表
                renderRolesList(roles);
                
                // 更新分页组件
                updateRolesPagination();
            })
            .catch(error => {
                console.error('加载角色列表失败:', error);
                showTips('加载角色列表失败，请稍后重试', 'error');
            });
    }
    
    // 更新角色分页组件
    function updateRolesPagination() {
        const paginationDiv = document.getElementById('rolesPagination');
        const totalCountSpan = document.getElementById('rolesTotalCount');
        const currentPageSpan = document.getElementById('currentRolesPageSpan');
        const totalPagesSpan = document.getElementById('rolesTotalPages');
        const prevPageBtn = document.getElementById('rolesPrevPage');
        const nextPageBtn = document.getElementById('rolesNextPage');
        const pageNumbersDiv = document.getElementById('rolesPageNumbers');
        
        if (!paginationDiv) return;
        
        // 更新统计信息
        if (totalCountSpan) {
            const startIndex = (currentRolesPage - 1) * rolesPageSize + 1;
            const endIndex = Math.min(currentRolesPage * rolesPageSize, rolesTotalCount);
            totalCountSpan.textContent = `显示第 ${startIndex} 到第 ${endIndex} 条记录，共 ${rolesTotalCount} 条记录`;
        }
        if (currentPageSpan) currentPageSpan.textContent = currentRolesPage;
        if (totalPagesSpan) totalPagesSpan.textContent = rolesTotalPages;
        
        // 显示或隐藏分页组件
        if (rolesTotalPages <= 1) {
            paginationDiv.style.display = 'none';
            return;
        } else {
            paginationDiv.style.display = 'flex';
        }
        
        // 更新上一页按钮状态
        if (prevPageBtn) {
            if (currentRolesPage <= 1) {
                prevPageBtn.classList.add('disabled');
            } else {
                prevPageBtn.classList.remove('disabled');
            }
        }
        
        // 更新下一页按钮状态
        if (nextPageBtn) {
            if (currentRolesPage >= rolesTotalPages) {
                nextPageBtn.classList.add('disabled');
            } else {
                nextPageBtn.classList.remove('disabled');
            }
        }
        
        // 生成页码按钮
        if (pageNumbersDiv) {
            pageNumbersDiv.innerHTML = '';
            
            // 计算显示的页码范围
            let startPage = Math.max(1, currentRolesPage - 2);
            let endPage = Math.min(rolesTotalPages, currentRolesPage + 2);
            
            // 如果总页数较少，显示所有页码
            if (rolesTotalPages <= 5) {
                startPage = 1;
                endPage = rolesTotalPages;
            }
            
            // 添加第一页
            if (startPage > 1) {
                const firstPageLi = document.createElement('li');
                firstPageLi.className = 'page-item';
                firstPageLi.innerHTML = `<a class="page-link" href="#" onclick="loadRolesPage(1)">1</a>`;
                pageNumbersDiv.appendChild(firstPageLi);
                
                if (startPage > 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    pageNumbersDiv.appendChild(ellipsisLi);
                }
            }
            
            // 添加页码按钮
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = 'page-item' + (i === currentRolesPage ? ' active' : '');
                pageLi.innerHTML = `<a class="page-link" href="#" onclick="loadRolesPage(${i})">${i}</a>`;
                pageNumbersDiv.appendChild(pageLi);
            }
            
            // 添加最后一页
            if (endPage < rolesTotalPages) {
                if (endPage < rolesTotalPages - 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    pageNumbersDiv.appendChild(ellipsisLi);
                }
                
                const lastPageLi = document.createElement('li');
                lastPageLi.className = 'page-item';
                lastPageLi.innerHTML = `<a class="page-link" href="#" onclick="loadRolesPage(${rolesTotalPages})">${rolesTotalPages}</a>`;
                pageNumbersDiv.appendChild(lastPageLi);
            }
        }
    }

    // 渲染角色列表
    function renderRolesList(roles) {
        const rolesTableBody = document.querySelector('#rolesTable tbody');
        rolesTableBody.innerHTML = '';
        
        roles.forEach(role => {
            const row = createRoleTableRow(role);
            rolesTableBody.appendChild(row);
        });
    }
    
    // 创建角色表格行
    function createRoleTableRow(role) {
        const row = document.createElement('tr');
        
        const formatDate = (dateString) => {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', {hour12: false});
        };
        

        
        row.innerHTML = `
            <td>${role.name}</td>
            <td>${role.display_name || '-'}</td>
            <td>${role.description || '-'}</td>
            <td>${formatDate(role.created_at)}</td>
            <td>
                {% if session.role == 'super_admin' %}
                <button class="btn btn-sm btn-primary mr-1" onclick="editRole('${role.name}')">
                    <i class="fas fa-edit"></i> 编辑
                </button>
                ${role.name !== 'super_admin' && role.name !== 'user' ? `
                <button class="btn btn-sm btn-danger" onclick="deleteRole('${role.name}')">
                    <i class="fas fa-trash"></i> 删除
                </button>` : ''}
                {% endif %}
            </td>
        `;
        
        return row;
    }
    
    // 获取角色边框颜色
    function getRoleBorderColor(roleName) {
        const colorMap = {
            'user': 'border-primary',
            'admin': 'border-warning',
            'user_admin': 'border-warning',
            'role_admin': 'border-warning',
            'super_admin': 'border-danger'
        };
        return colorMap[roleName] || 'border-secondary';
    }
    
    // 获取角色图标
    function getRoleIcon(roleName) {
        const iconMap = {
            'user': 'fas fa-user',
            'admin': 'fas fa-user-tie',
            'user_admin': 'fas fa-users-cog',
            'role_admin': 'fas fa-user-shield',
            'super_admin': 'fas fa-crown'
        };
        return iconMap[roleName] || 'fas fa-user-circle';
    }
    
    // 获取角色文字颜色
    function getRoleTextColor(roleName) {
        const colorMap = {
            'user': 'text-primary',
            'admin': 'text-warning',
            'user_admin': 'text-warning',
            'role_admin': 'text-warning',
            'super_admin': 'text-danger'
        };
        return colorMap[roleName] || 'text-secondary';
    }
    
    {% if session.role == 'super_admin' %}
    // 显示创建角色模态框
    function showCreateRoleModal() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">创建新角色</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="createRoleForm">
                            <div class="mb-3">
                                <label for="roleName" class="form-label">角色名称</label>
                                <input type="text" class="form-control" id="roleName" required>
                                <div class="form-text">角色名称用于系统内部标识，建议使用英文</div>
                            </div>
                            <div class="mb-3">
                                <label for="roleDisplayName" class="form-label">显示名称</label>
                                <input type="text" class="form-control" id="roleDisplayName" required>
                            </div>
                            <div class="mb-3">
                                <label for="roleDescription" class="form-label">角色描述</label>
                                <textarea class="form-control" id="roleDescription" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="rolePermissions" class="form-label">权限列表</label>
                                <textarea class="form-control" id="rolePermissions" rows="3" placeholder="请输入权限描述，如：查看用户列表,管理用户状态"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="createRole()">创建角色</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
    }
    
    // 创建角色
    function createRole() {
        const name = document.getElementById('roleName').value.trim();
        const displayName = document.getElementById('roleDisplayName').value.trim();
        const description = document.getElementById('roleDescription').value.trim();
        const permissionsText = document.getElementById('rolePermissions').value.trim();
        const permissions = permissionsText ? permissionsText.split(',').map(p => p.trim()).filter(p => p) : [];
        
        if (!name || !displayName) {
            showTips('请填写角色名称和显示名称', 'warning');
            return;
        }
        
        fetch('/admin/roles', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                display_name: displayName,
                description: description,
                permissions: permissions
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络请求失败: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 200) {
                    showTips('角色创建成功！', 'success');
                    // 查找当前打开的创建角色模态框并关闭
                    const createModal = document.querySelector('.modal.show');
                    if (createModal) {
                        const modalInstance = bootstrap.Modal.getInstance(createModal);
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                    }
                    loadRoles(); // 重新加载角色列表
                } else {
                    showTips('创建失败: ' + (data.message || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('创建角色失败:', error);
                showTips('创建角色失败，请稍后重试', 'error');
            });
    }
    
    // 编辑角色
    function editRole(roleName) {
        // 根据角色名称获取角色详细信息
        fetch(`/admin/roles/${encodeURIComponent(roleName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.code !== 200) {
                    showTips('获取角色信息失败: ' + data.message, 'error');
                    return;
                }
                
                showEditRoleModal(data.data);
            })
            .catch(error => {
                console.error('获取角色信息失败:', error);
                showTips('获取角色信息失败，请稍后重试', 'error');
            });
    }
    
    // 显示编辑角色模态框
    function showEditRoleModal(role) {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">编辑角色: ${role.display_name}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editRoleForm">
                            <div class="mb-3">
                                <label for="editRoleName" class="form-label">角色名称</label>
                                <input type="text" class="form-control" id="editRoleName" value="${role.name}" readonly>
                                <div class="form-text">角色名称不可修改</div>
                            </div>
                            <div class="mb-3">
                                <label for="editRoleDisplayName" class="form-label">显示名称</label>
                                <input type="text" class="form-control" id="editRoleDisplayName" value="${role.display_name}" required>
                            </div>
                            <div class="mb-3">
                                <label for="editRoleDescription" class="form-label">角色描述</label>
                                <textarea class="form-control" id="editRoleDescription" rows="3">${role.description || ''}</textarea>
                            </div>
                            <div class="mb-3">
                                <label for="editRolePermissions" class="form-label">权限列表</label>
                                <textarea class="form-control" id="editRolePermissions" rows="3">${Array.isArray(role.permissions) ? role.permissions.join(',') : (role.permissions || '')}</textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="updateRole(${role.id})">保存修改</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
    }
    
    // 更新角色
    function updateRole(roleId) {
        const displayName = document.getElementById('editRoleDisplayName').value.trim();
        const description = document.getElementById('editRoleDescription').value.trim();
        const permissionsText = document.getElementById('editRolePermissions').value.trim();
        const permissions = permissionsText ? permissionsText.split(',').map(p => p.trim()).filter(p => p) : [];
        
        if (!displayName) {
            showTips('请填写显示名称', 'warning');
            return;
        }
        
        fetch(`/admin/roles/${roleId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                display_name: displayName,
                description: description,
                permissions: permissions
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络请求失败: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 200) {
                    showTips('角色更新成功！', 'success');
                    // 查找当前打开的编辑角色模态框并关闭
                    const editModal = document.querySelector('.modal.show');
                    if (editModal) {
                        const modalInstance = bootstrap.Modal.getInstance(editModal);
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                    }
                    // 延迟重新加载角色列表，避免与成功提示冲突
                    setTimeout(() => {
                        loadRoles();
                    }, 500);
                } else {
                    showTips('更新失败: ' + (data.message || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('更新角色失败:', error);
                showTips('更新角色失败，请稍后重试', 'error');
            });
    }
    
    // 删除角色
    async function deleteRole(roleName) {
        const confirmed = await showConfirm(`确定要删除角色 "${roleName}" 吗？\n\n注意：如果有用户正在使用此角色，删除操作将失败。`);
        if (!confirmed) {
            return;
        }
        
        fetch(`/admin/roles/${roleName}`, {
            method: 'DELETE'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络请求失败: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 200) {
                    showTips('角色删除成功！', 'success');
                    loadRoles(); // 重新加载角色列表
                } else {
                    showTips('删除失败: ' + (data.message || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('删除角色失败:', error);
                showTips('删除角色失败，请稍后重试', 'error');
            });
    }
    {% endif %}
    
    // 页面加载时初始化角色列表
    document.addEventListener('DOMContentLoaded', function() {
        // 如果当前标签页是角色管理，则加载角色列表
        const rolesTab = document.getElementById('roles');
        if (rolesTab && rolesTab.classList.contains('active')) {
            loadRoles();
        }
        
        // 监听标签页切换事件
        const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
        tabButtons.forEach(button => {
            button.addEventListener('shown.bs.tab', function(event) {
                if (event.target.getAttribute('href') === '#roles') {
                    loadRoles();
                }
            });
        });
    });
    {% endif %}
    {% endif %}
</script>
{% endblock %}